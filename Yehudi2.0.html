<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Mushlam2.0</title>
  <style>
    /* ------------------------------------
       Design tokens + responsive helpers
    -------------------------------------*/
    :root{
      --bg:#056666;--panel:#000000;--card:linear-gradient(150deg,#056666,#0e1218);
      --muted:#9aa4b2;--text:#ffffff;--accent:#70b5ff;--accent-2:#9ef0a3;--gold:#ffd24d;
      --han-red:#FF0000;

      /* Echelles fluides */
      --radius-s:12px; --radius-m:16px; --radius-l:18px; --radius-xl:24px; --radius-pill:999px;
      --shadow-soft:0 10px 30px rgba(0,0,0,.35);
      --ring:1px solid rgba(255,255,255,.14);

      /* Hauteur viewport iOS-safe */
      --dvh: 100vh; /* fallback */
      --gap: clamp(10px, 1.8vmin, 18px);
      --page-pad: clamp(14px, 2vw, 24px);
    }
    @supports (height: 100dvh){ :root{ --dvh: 100dvh; } }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0e1218,#056666);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      position:relative;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: env(safe-area-inset-bottom);
      overflow-x: hidden;
    }

    /* ------------------
       Animations globales
    -------------------*/
    @keyframes pulsation { 0%,100%{ transform:scale(1); opacity:.8 } 50%{ transform:scale(1.1); opacity:1 } }
    @keyframes stellarConversion {
      0%{transform:scale(1) rotate(0deg);filter:drop-shadow(0 0 15px var(--han-red))}
      50%{transform:scale(1.5) rotate(180deg);filter:drop-shadow(0 0 30px var(--gold))}
      100%{transform:scale(1) rotate(360deg);filter:drop-shadow(0 0 8px var(--gold))}
    }
    @keyframes cosmicCelebration {
      0%{transform:rotate(0) scale(1)}25%{transform:rotate(90deg) scale(1.2)}50%{transform:rotate(180deg) scale(1)}75%{transform:rotate(270deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}
    }

    /* Accessibilité: réduire les animations si demandé */
    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition:none !important }
    }
@media (max-width:800px){
  #cookieWrap{ padding-bottom: 56px; } /* espace de respiration pour les orbites */
}

/* Fix PC: empêcher tout “tiling” du gradient */
@media (min-width: 1000px){
  html, body{ min-height: 100%; }
  body{
    background-repeat: no-repeat !important;
    background-size: 100% 100% !important;  /* étire le gradient à la fenêtre */
    background-attachment: fixed;           /* optionnel : fond stable au scroll */
  }
}


    /* Message de conversion */
    .conversionMessage{
      position:fixed; inset:auto 0 0 0; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.9); color:#fff; padding:20px 40px; border-radius:15px; font-size:20px; font-weight:700; z-index:10000;
      animation: fadeInOut 1.5s ease-out forwards; border:2px solid var(--gold); box-shadow:0 0 30px rgba(255,210,77,.6)
    }
    @keyframes fadeInOut{ 0%{opacity:0;transform:translate(-50%,-50%) scale(.8)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(.9)} }

    /* Overlay de célébration */
    .celebrationOverlay{ position:fixed; inset:0; z-index:9999; pointer-events:none; background:radial-gradient(circle at center,transparent 0%, rgba(255,210,77,.1) 50%, transparent 100%); animation: cosmicPulse 10s ease-in-out }
    @keyframes cosmicPulse{0%,100%{opacity:0}10%,90%{opacity:1}}
    .celebrationStar{ position:absolute; width:60px; height:60px; animation: starFloat 10s ease-out forwards }
    @keyframes starFloat{0%{transform:translate(0,0) rotate(0) scale(0);opacity:0}10%{transform:translate(0,-20px) rotate(36deg) scale(1);opacity:1}90%{transform:translate(var(--x),var(--y)) rotate(360deg) scale(1);opacity:1}100%{transform:translate(var(--x),var(--y)) rotate(400deg) scale(0);opacity:0}}

    /* couches décoratives */
    #bgIconLayer{ position:fixed; inset:0; pointer-events:none; z-index:0 }

    /* --------------
       Conteneur page
       --------------*/
    #gameContainer{ max-width:min(1200px, 96vw); margin:0 auto; padding:var(--page-pad); position:relative; z-index:1 }

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    header h1{
      font-size:clamp(24px,3.2vw,36px); margin:0; font-weight:900; letter-spacing:.4px; line-height:1.1; position:relative;
      background:linear-gradient(180deg,#fff 0%, var(--accent) 100%); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 8px rgba(255,210,77,.55), 0 0 22px rgba(112,181,255,.35);
      animation:titleFade .6s ease-out both, titleGlow 2.6s ease-in-out infinite;
    }
    header h1::after{ content:""; position:absolute; left:50%; top:100%; width:62%; height:3px; border-radius:var(--radius-pill); transform:translateX(-50%); background:linear-gradient(90deg,transparent,var(--accent),transparent); filter:blur(1px); animation:underlineGlow 2.6s ease-in-out infinite }
    @keyframes titleFade{from{opacity:0;transform:translateY(6px) scale(.98)}to{opacity:1;transform:none}}
    @keyframes titleGlow{0%,100%{text-shadow:0 0 6px rgba(255,210,77,0),0 0 18px rgba(112,181,255,0)}50%{text-shadow:0 0 10px rgba(255,210,77,.55),0 0 28px rgba(112,181,255,.45)}}
    @keyframes underlineGlow{0%,100%{opacity:.55}50%{opacity:1}}

    /* HUD flexible (auto-fit) */
    .hud{display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:10px; flex:1; min-width:260px}
    .pill{background:var(--card);border:1px solid #2a3142;border-radius:var(--radius-pill);padding:10px 14px;font-weight:700;text-align:center}

    /* Layout adaptatif avec breakpoints intermédiaires + container queries */
    .layout{ display:grid; grid-template-columns: minmax(360px,1fr) minmax(280px,.8fr); gap:14px }
    @media (min-width: 600px) and (max-width: 900px){ .layout{ grid-template-columns: 1.2fr .9fr } }
    @media (min-width: 1200px){ .layout{ grid-template-columns: 1.1fr .9fr } }

    .clickZone{
      background:var(--panel); border:1px solid #2a3142; border-radius:var(--radius-l); padding:20px; position:relative; overflow:hidden;
      min-height: clamp(420px, 74var(--dvh), 560px);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      box-shadow: var(--shadow-soft);
    }

    #cookieWrap{ position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; flex:1 }
    #cookieImage{
      width:clamp(160px, 48vmin, 360px); max-width:360px; aspect-ratio:1/1; object-fit:cover; border-radius:50%;
      cursor:pointer; user-select:none; transition:transform .08s ease, filter .2s ease; box-shadow:0 10px 30px rgba(0,0,0,.45);
      touch-action: manipulation;
    }
    #cookieImage:active{transform:scale(.96)} #cookieImage:hover{filter:saturate(1.05)}

    /* rotation continue */
    #cookieSpinner{display:inline-block}
    .spin{animation: cookieSpin var(--spin-speed, 10s) linear infinite; filter: drop-shadow(0 0 1px #056666) drop-shadow(0 0 5px rgba(150,150,150,.55))}
    @keyframes cookieSpin{to{transform: rotate(360deg)}}

    /* icônes en orbite */
    #orbitLayer{position:absolute;left:50%;top:50%;width:0;height:0;pointer-events:none;z-index:3;perspective:800px}
    .orb{position:absolute;left:0;top:0;z-index: 1;transform:rotate(var(--a0,0deg));transform-origin:0 0;animation:spinOrbit var(--speed,18s) linear infinite}
    .orb.han .orbitIcon{ filter: drop-shadow(0 0 12px var(--han-red)) drop-shadow(0 0 25px rgba(255,0,0,.6));z-index: 10; width: calc(var(--size,32px) * 1.2); height: calc(var(--size,32px) * 1.2); --r: calc(var(--base-r, 160px) * 0.85); animation: wobble calc(var(--wobble,2.6s) * 1.3) ease-in-out infinite }
    .orbitIcon{ display:block; width:var(--size,32px); height:var(--size,32px); will-change:transform; transform-origin:center; animation:wobble var(--wobble,2.6s) ease-in-out infinite; filter: drop-shadow(0 0 8px #ffd24d) drop-shadow(0 0 18px rgba(255,215,0,.55)) }
    @keyframes spinOrbit{to{transform:rotate(calc(var(--a0,0deg) + 360deg))}}
    @keyframes wobble{0%{transform:translateX(var(--r,160px)) rotateY(-20deg) scale(.9)}50%{transform:translateX(var(--r,160px)) rotateY(20deg) scale(1.1)}100%{transform:translateX(var(--r,160px)) rotateY(-20deg) scale(.9)}}

    .clickHint{margin-top:8px;color:var(--muted);font-size:14px;text-align:center}

    /* Barre de contrôles = bottom nav collante sur mobile, dégagée sur desktop */
    .controls{position:absolute;inset:auto 12px 12px 12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .btn{background:var(--card);border:1px solid #2a3142;color:var(--text);padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer;touch-action:manipulation}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .switch{display:flex;align-items:center;gap:8px;color:var(--muted)}


/* Contrôles sortis de la clickZone */
.controls-global{
  grid-column: 1 / -1;               /* span sur les 2 colonnes de .layout */
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 10px;
}

/* Même look “barre collante” sur mobile */
@media (max-width: 800px){
  .controls-global{
    position: sticky;
    bottom: 8px;
    inset: auto 0 8px 0;
    padding: 8px;
    background: rgba(10,12,18,.45);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius-pill);
    z-index: 5;
  }
}

/* La clickZone n'a plus besoin de réserver de place pour les contrôles */
@media (min-width: 1000px){
  .clickZone{ padding-bottom: 18px; }   /* tu peux même retirer totalement la ligne si tu préfères */
}
@media (max-width: 800px){
  .clickZone{ padding-bottom: 12px; }
}



    /* Boutique: fait office de conteneur pour container queries */
    .shop{
      background:var(--panel); border:1px solid #2a3142; border-radius:var(--radius-l); padding:16px;
      max-height:none; height:auto; overflow-y:auto; align-self:start; box-shadow: var(--shadow-soft);
      container-type: inline-size;
    }
    .shop h2{margin:2px 6px 10px;font-size:18px;color:#c9d7e1; position:sticky; top:0; padding:6px 4px; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0)); backdrop-filter: blur(2px); z-index:2}

    .upgrade{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;background:var(--card);border:1px solid #2a3142;border-radius:14px;padding:10px 12px;margin:10px 4px;transition:all .3s ease}
    .upgrade.pulsing{animation:pulsation 2s ease-in-out}
    .upgrade img{width:56px;height:56px;border-radius:12px;object-fit:cover}
    .u-title{font-weight:800;letter-spacing:.2px}
    .u-desc{color:var(--muted);font-size:12.5px;margin-top:2px}
    .u-meta{display:flex;gap:10px;margin-top:6px;color:#c9d7e1;font-size:13px;flex-wrap:wrap}
    .u-actions{display:flex;flex-direction:column;align-items:end;gap:8px}
    .price{font-weight:800}
    .buy{background:linear-gradient(180deg,#2a6fff,#1a57e0);border:none;padding:8px 12px;border-radius:10px;color:white;font-weight:800;cursor:pointer;touch-action:manipulation}
    .buy[disabled]{background:#2b3550;opacity:.6}

    /* Container queries: compacter la carte quand la colonne est étroite */
    @container (max-width: 520px){
      .upgrade{ grid-template-columns:56px 1fr; }
      .u-actions{ grid-column:1/-1; align-items:stretch; }
      .buy{ width:100%; min-height:44px }
    }
    @container (min-width: 780px){
      .upgrade{ grid-template-columns:56px 1fr auto; }
      .u-actions{ grid-column:auto; }
    }

    /* +N flottant */
    .float{position:absolute;left:0;top:0;pointer-events:none;translate:-50% -50%;font-weight:800;text-shadow:0 2px 8px rgba(0,0,0,.5)}
    .float.go{animation:rise .9s ease-out forwards}
    @keyframes rise{0%{opacity:0;transform:translateY(0) scale(.9)}10%{opacity:1}100%{opacity:0;transform:translateY(-80px) scale(1.1)}}

    /* mini-cookies */
    #burstLayer{position:fixed;inset:0;pointer-events:none;z-index:4}
    .miniCookie{position:absolute;opacity:0;animation:popFade var(--burst-duration,3s) ease-out forwards;will-change:transform,opacity;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
    @keyframes popFade{0%{opacity:0;transform:translateY(0) scale(.6) rotate(0)}10%{opacity:1}100%{opacity:0;transform:translateY(-20px) scale(1) rotate(360deg)}}

    /* Mega flash */
    #megaFlash{ position:fixed; inset:0; pointer-events:none; z-index:2147483000; display:none }
    #megaFlash.show{ display:block; animation: fadeAll 2.2s ease-out forwards }
    #megaFlash::before{ content:""; position:fixed; inset:-20vmax; opacity:.9; filter:blur(8px); background:conic-gradient(from 0deg, rgba(255,215,0,0) 0 10deg, rgba(255,215,0,.35) 10deg 12deg, transparent 12deg 20deg); animation: spin 1s linear infinite }
    #megaFlash img{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.2); width:min(72vmin,820px); height:auto; filter: drop-shadow(0 0 30px rgba(255,215,0,.9)) drop-shadow(0 0 80px rgba(255,215,0,.6)); animation: boom 2.2s cubic-bezier(.2,.8,.2,1) forwards; will-change: transform, opacity }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    @keyframes boom{ 0%{transform:translate(-50%,-50%) scale(.2)} 70%{transform:translate(-50%,-50%) scale(1.12)} 100%{transform:translate(-50%,-50%) scale(1)} }
    @keyframes fadeAll{ 0%{opacity:0} 15%{opacity:1} 100%{opacity:0} }

    /* icônes upgrade1 en background */
    .bgIcon{ position:absolute; width:100px; height:auto; opacity:.08; filter:blur(.8px); transform:translate(-50%,-50%) rotate(var(--rot,0deg)) scale(var(--scale,1)) }

    .badge{background:#223048;border:1px solid #2a3142;border-radius:8px;padding:2px 6px;font-size:11px;color:#c9d7e1}
    footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}

    /* ----------------------
       Mobile ultra soigné
       ----------------------*/
    @media (max-width: 800px){
      html{ font-size:106% }
      :root{ --panel: rgba(14,18,24,.72); --card: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)) }
      body{ background: radial-gradient(1200px 600px at 50% -10%, #12304a 0%, #0e1218 38%, #0b0e13 100%); background-attachment: fixed }

      .layout{ grid-template-columns: 1fr !important; gap:16px }
      #gameContainer{ padding: clamp(12px, 3.5vw, 18px) }

      header{ flex-direction:column; align-items:center; gap:10px; text-align:center }
      header h1{ font-size: clamp(22px, 7vw, 28px); text-shadow: 0 0 6px rgba(255,210,77,.35), 0 0 12px rgba(112,181,255,.25) }
      header h1::after{ width:46%; height:2px }

      .hud{ width:100%; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px }
      .pill{ padding:10px 12px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:var(--ring); box-shadow: 0 6px 20px rgba(0,0,0,.25) inset, 0 2px 12px rgba(0,0,0,.18) }

      .clickZone{ min-height: clamp(520px, 74dvh, 740px); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.12); box-shadow: 0 14px 38px rgba(0,0,0,.35); padding:18px }

      #cookieImage{ width: clamp(200px, 62vmin, 360px); box-shadow: 0 10px 26px rgba(0,0,0,.35) }

      #orbitLayer{ perspective: 700px }
      .orbitIcon{ filter: drop-shadow(0 0 6px rgba(255,210,77,.45)) }

      .clickHint{ font-size:13px; opacity:.85 }


/* Contrôles sortis de la zone de clic */
.controls-global{
  grid-column: 1 / -1;        /* une rangée pleine largeur sous les deux colonnes */
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:10px;
}

/* Desktop : la clickZone n’a plus besoin d’un gros padding bas */
@media (min-width:1000px){
  .clickZone{ padding-bottom: 18px; }
  /* masque l'ancienne barre si tu l'as laissée dans le DOM par prudence */
  .controls{ display:none; }
}

/* Mobile : on garde la barre collante en bas (si tu la veux aussi en mobile) */
@media (max-width:800px){
  .controls-global{
    position: sticky;
    bottom: 8px;
    inset: auto 0 8px 0;
    padding: 8px;
    background: rgba(10,12,18,.45);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius-pill);
    z-index: 5;
  }
}

      .controls{
        position: sticky; bottom: 8px; inset:auto 0 8px 0; margin-top:14px; padding:8px; justify-content:center; gap:10px; flex-wrap:nowrap;
        background: rgba(10,12,18,.45); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-pill);
      }
      .btn,.buy,button{ min-height:48px; padding:12px 16px; font-size:16px; border-radius:14px; box-shadow: 0 4px 16px rgba(0,0,0,.25) }

      .shop{ padding:14px; border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(6px); max-height: min(600px, 58dvh); overflow-y:auto }
      .shop h2{ margin:4px 0 8px; font-size:18px; color:#e5f2ff; text-align:center }

      .upgrade{ grid-template-columns:56px 1fr; gap:12px; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.14); border-radius:16px; padding:12px; margin:10px 2px; box-shadow: 0 8px 24px rgba(0,0,0,.28) }
      .upgrade img{ width:56px; height:56px; border-radius:12px }
      .u-title{ font-size:16px }
      .u-desc{ font-size:13px; opacity:.9 }
      .u-meta{ margin-top:6px; font-size:12.5px }
      .u-actions{ grid-column: 1 / -1; align-items:stretch }
      .price{ font-size:16px }
      .buy{ width:100%; background: linear-gradient(180deg,#3292ff,#1c62ea); border:1px solid rgba(255,255,255,.2); color:#fff; font-weight:800; text-shadow: 0 1px 0 rgba(0,0,0,.25) }
      .buy:active{ transform: translateY(1px) scale(.98) }
      .buy[disabled]{ background:#2b3550; opacity:.7 }

      #bgIconLayer, #burstLayer, #megaFlash{ pointer-events: none !important }
      .spin{ --spin-speed: 12s }
      .miniCookie{ filter: drop-shadow(0 1px 4px rgba(0,0,0,.35)) }
    }

    /* Paysage smartphone: réduire la zone et passer en split */
    @media (max-height: 520px) and (orientation: landscape){
      .layout{ grid-template-columns: 1.1fr .9fr !important }
      .clickZone{ min-height: clamp(360px, 72var(--dvh), 520px) }
      #cookieImage{ width: clamp(140px, 36vmin, 260px) }
      .controls{ position:static; margin-top:10px }
      .shop{ max-height: 70dvh }
    }
	
	@media (min-width:1000px){
  .controls-global{
    grid-column: 2;           /* colonne de droite (la boutique) */
    justify-content:flex-start;
    margin-top:12px;
  }
  .clickZone{ padding-bottom: 18px; }
  .controls{ display:none; }
}


    @media (pointer: coarse){ .upgrade, .btn, .buy{ min-height:48px } }
    @media (hover: none){ .hover-only, .tooltip-on-hover{ display:none } }

    /* --- FX reset de prix (rewind) --- */
    @keyframes costFlip{ 0%{transform: rotateX(0) scale(1)} 40%{transform: rotateX(90deg) scale(1.12)} 100%{transform: rotateX(0) scale(1)} }
    .price-reset{ color: var(--gold) !important; animation: costFlip 800ms ease }

    /* overlay (réutilise fadeAll) */
    #priceResetFX{ position: fixed; inset: 0; pointer-events: none; z-index: 2147483002; display: none }
    #priceResetFX.show{ display:block; animation: fadeAll 1.4s ease-out forwards }
    #priceResetFX .rewind{ position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: min(22vmin, 160px); text-shadow: 0 0 30px rgba(255,210,77,.85), 0 0 80px rgba(255,210,77,.45); animation: pop 900ms ease-out }
    @keyframes pop{ 0%{ transform: translate(-50%,-50%) scale(.7) } 40%{ transform: translate(-50%,-50%) scale(1.15) } 100%{ transform: translate(-50%,-50%) scale(1) } }

    /* === FINALE COSMIQUE (fin du jeu) === */
    #finaleOverlay{ position:fixed; inset:0; z-index:2147483646; pointer-events:auto; background: radial-gradient(1200px 600px at 50% 40%, rgba(255,255,255,.06), rgba(255,215,0,.05), rgba(0,0,0,.92) 70%); animation: finaleFadeIn .6s ease-out }
    @keyframes finaleFadeIn{from{opacity:0} to{opacity:1}}
    #finaleOverlay .rays{ position:absolute; inset:-20vmax; background:conic-gradient(from 0deg, transparent 0 8deg, rgba(255,215,0,.35) 8deg 10deg, transparent 10deg 20deg); filter:blur(8px); opacity:.8; animation: spin 10s linear infinite }
    #finaleOverlay .bigIcon{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.2); width:min(60vmin,560px); height:auto; filter: drop-shadow(0 0 30px rgba(255,215,0,.9)) drop-shadow(0 0 80px rgba(255,215,0,.5)); animation: boom 2200ms cubic-bezier(.2,.8,.2,1) forwards }
    #finaleOverlay .title{ position:absolute; left:50%; top:38%; transform:translate(-50%,-50%); font-size:min(11vmin,64px); font-weight:900; letter-spacing:.08em; text-transform:uppercase; color:#fff; text-shadow:0 0 30px rgba(255,210,77,.8), 0 0 80px rgba(112,181,255,.35) }
    #finaleOverlay .title .shine{ background:linear-gradient(90deg,#fff, #ffd24d, #fff); -webkit-background-clip:text; background-clip:text; color:transparent; animation: shineSweep 2.4s ease-in-out infinite }
    @keyframes shineSweep{0%{filter:brightness(1)} 50%{filter:brightness(1.6)} 100%{filter:brightness(1)}}
    #finaleOverlay .subtitle{ position:absolute; left:50%; top:48%; transform:translateX(-50%); opacity:.95 }

    .twinkle{ position:absolute; width:3px; height:3px; background:#fff; border-radius:50%; opacity:.8; animation: tw 2.2s ease-in-out infinite }
    @keyframes tw{0%,100%{transform:scale(.6); opacity:.6} 50%{transform:scale(1.4); opacity:1}}
    .firework{position:absolute; width:8px; height:8px; left:0; top:0}
    .firework .p{ position:absolute; width:6px; height:6px; border-radius:50%; background: currentColor; opacity:0; animation: fw 900ms ease-out forwards }
    @keyframes fw{ 0%{transform:translate(0,0) scale(.3); opacity:1} 100%{transform:translate(var(--dx), var(--dy)) scale(1.2); opacity:0} }
    .confetti{ position:absolute; width:8px; height:14px; background:var(--c, #ffd24d); transform: rotate(var(--r,0deg)); opacity:0; will-change: transform, opacity; animation: conf 2200ms ease-out forwards }
    @keyframes conf{ 0%{opacity:0; transform:translateY(0) rotate(0)} 10%{opacity:1} 100%{opacity:0; transform:translateY(80vh) rotate(720deg)} }
    .finaleCredits{ position:absolute; left:50%; bottom:-40%; transform:translateX(-50%); width:min(92vw, 720px); text-align:center; color:#eaeef8; opacity:.95; animation: creditsUp 166s linear forwards }
    .finaleCredits h3{margin:0 0 8px; letter-spacing:.1em; color:#ffd24d}
    .finaleCredits p{margin:4px 0; opacity:.9}
    @keyframes creditsUp{from{bottom:-50%} to{bottom:110%}}

    /* Focus visibles pour accessibilité clavier */
    :focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:10px }
  
    /* ================================
       PATCH RESPONSIVE — 2025-09-02
       - Desktop: clickZone sticky & plein écran utile
       - Mobile: supprimer le scroll interne de la boutique
       ================================ */
    @media (min-width: 1000px){
      /* Colonne gauche toujours visible et bien centrée sur grands écrans */
      .layout{ align-items: start; }
      .clickZone{
        position: sticky;
        top: var(--page-pad);
        height: calc(100dvh - var(--page-pad) * 2);
        min-height: 640px;
        padding-bottom: clamp(80px, 12vh, 160px); /* évite que les contrôles chevauchent la kippa */
      }
      #cookieWrap{ justify-content: center; }
      /* La boutique laisse la page scroller normalement */
      .shop{ max-height: none; overflow: visible; }
    }

    /* Mobile: une seule zone de défilement (la page) */
    @media (max-width: 800px){
      .shop{ max-height: none !important; overflow: visible !important; }
    }
  </style>
</head>
<body>
  <div id="bgIconLayer" aria-hidden="true"></div>
  <div id="megaFlash" aria-hidden="true"></div>
  <div id="priceResetFX" aria-hidden="true"></div>

  <div id="gameContainer">
    <header>
      <h1>Yehudi Clicker</h1>
      <div class="hud">
        <div id="currencyDisplay" class="pill" aria-live="polite">Kippa : 0</div>
        <div id="cpsDisplay" class="pill">KpS : 0</div>
        <div id="cpcDisplay" class="pill">Par clic : 1</div>
      </div>
    </header>

    <div class="layout">
      <section class="clickZone" aria-label="Zone de clic">
        <div id="cookieWrap">
          <div id="cookieSpinner" class="spin">
            <img id="cookieImage" src="https://i.postimg.cc/dVRtQ1xP/kippa.png" alt="Grosse Kippa cliquable">
          </div>

          <div id="orbitLayer" aria-hidden="true"></div>
        </div>


        <div id="floatLayer" aria-hidden="true"></div>
        <div id="burstLayer" aria-hidden="true"></div>

        <audio id="clickSound" src="https://han-han-boop.github.io/Mushlam/Kes.mp3" preload="auto"></audio>
      </section>

      <aside class="shop" id="shop" aria-label="Boutique">
        <h2>Boutique</h2>
      </aside>
	  
	  <div class="controls-global" id="globalControls">
  <button id="resetBtn" class="btn" title="Réinitialiser la progression">Réinitialiser</button>
  <label class="switch"><input type="checkbox" id="muteToggle"> Muet</label>

</div>




  <script>
  /* =========================
     Perf helpers / constantes
     ========================= */
  let lastBurstAt = 0;
  const FLOAT_MAX = 12;               // max "+N" visibles
  const HUD_INTERVAL = 150;           // ms => ~6-7 fps HUD
  const SHOP_INTERVAL = 400;          // ms => ~2-3 fps Shop

  let hudDirty = true, shopDirty = true;
  let lastHUDStamp = 0, lastShopStamp = 0;

  function markHUD(){ hudDirty = true; }
  function markShop(){ shopDirty = true; }

  // ====== CONFIG / ÉQUILIBRAGE ======
  const COST_FACTOR_DEFAULT = 1.25;
  const TICK_MS = 250;
  const HAN_KPS_PENALTY = -1000;
  const HAN_SPAWN_CHANCE = 0.2; // ta valeur
  const BOOST_HAN_KPS_INCREASE = 3;

  const isTouch = matchMedia('(pointer: coarse)').matches;

  // ====== ÉTAT ======
  let cookies = 0, muted = false, lastOrbitLevel = -1, lastBgCount = -1;            
  let hanCount = 0;
  let conversionActive = false;
  let celebrationActive = false;
  
  const upgrades = {
    upgrade1:{ id:'upgrade1', name:'Synagogue', desc:'Augmente les Kippas gagnés par clic.', icon:'https://i.postimg.cc/gJxx0phV/synagogue.png', sound:'https://han-han-boop.github.io/Mushlam/Mushlam.mp3', level:0, baseCost:2, cost:2, costFactor:COST_FACTOR_DEFAULT, multiplier:1 },
    upgrade2:{ id:'upgrade2', name:'Rabbin', desc:'Produit des Kippas automatiquement (KpS).', icon:'https://i.postimg.cc/C5Ddj4md/Rabbi.png', sound:'https://han-han-boop.github.io/Mushlam/ashk.mp3', level:0, baseCost:25, cost:25, costFactor:COST_FACTOR_DEFAULT, production:5 },
    upgrade3:{ id:'upgrade3', name:'Le Peuple Elu', desc:'Augmente toutes les productions de 25% par niveau.', icon:'https://i.postimg.cc/k5c4s4QF/elu.png', sound:'https://han-han-boop.github.io/Mushlam/Ye.mp3', level:0, baseCost:100, cost:100, costFactor:1.3, multiplier:25 },
    upgrade4:{ id:'upgrade4', name:'Retour en terre Sainte', desc:'Augmente le KpS des Rabbin de +3 / niveau et +1 Kippa par Synagogue', icon:'https://han-han-boop.github.io/Mushlam/TS.png', hanIcon:'https://han-han-boop.github.io/Mushlam/Arvi.png', sound:'https://han-han-boop.github.io/Mushlam/Kal.mp3', level:0, baseCost:100000, cost:100000, costFactor:1.4 },
    upgrade5:{ id:'upgrade5', name:'Le Dôme de fer', desc:'Convertit tous les Arvis.', icon:'https://han-han-boop.github.io/Mushlam/Dome.png', sound:'https://han-han-boop.github.io/Mushlam/Arv.mp3', level:0, baseCost:500000, cost:500000, costFactor:1.2, isPassive:true },
    upgrade7:{ id:'upgrade7', name:'Bar Mitzvah', desc:'Remet le coût de toutes les autres upgrades à leur prix initial.', icon:'https://han-han-boop.github.io/Mushlam/Bar.png', sound:'https://han-han-boop.github.io/Mushlam/Tov.mp3', level:0, baseCost:7500000, cost:7500000, costFactor:2.0, isPassive:true },
    upgrade6:{ id:'upgrade6', name:'לחץ כדי לשלוח את הנתונים שלך למארק צוקרברג', desc:'תודה על המידע האישי שלך', icon:'https://han-han-boop.github.io/Mushlam/imgb.png', hoicone:'https://i.postimg.cc/k5c4s4QF/elu.png', sound:'https://han-han-boop.github.io/Mushlam/Hava.mp3', level:0, baseCost:1000000000, cost:1000000000, costFactor:2, isPassive:true }
  };

  // ====== OUTILS ======
  const nf = new Intl.NumberFormat('fr-FR');
  const shopEl = document.getElementById('shop');
  const cookieImg = document.getElementById('cookieImage');
  cookieImg.decoding = 'async';
  cookieImg.loading  = 'eager';

  const currencyDisplay = document.getElementById('currencyDisplay');
  const cpsDisplay = document.getElementById('cpsDisplay');
  const cpcDisplay = document.getElementById('cpcDisplay');
  const clickSound = document.getElementById('clickSound');
  const floatLayer = document.getElementById('floatLayer');
  const burstLayer = document.getElementById('burstLayer');
  const megaFlash = document.getElementById('megaFlash');
  const orbitLayer = document.getElementById('orbitLayer');
  const muteToggle = document.getElementById('muteToggle');
  const resetBtn = document.getElementById('resetBtn');
  const bgIconLayer = document.getElementById('bgIconLayer');
  const cookieWrap = document.getElementById('cookieWrap');

  // flush propre à la fermeture/refresh
  window.addEventListener('beforeunload', () => { try { save(); } catch {} });
  
  // --- Versionnage de la sauvegarde / reset one-shot ---
const BUILD_KEY = 'mushlam-build';
const BUILD_ID  = '2-0';     // ← change ce tag à chaque déploiement où tu veux reset
const SAVE_KEY  = 'cookie-clicker-save-v2';   // nouvelle clé (bump)
const OLD_KEYS  = ['cookie-clicker-save'];    // anciennes clés à purger une fois

// Reset auto la première fois que ce build s'ouvre
(function oneTimeBuildReset(){
  const prev = localStorage.getItem(BUILD_KEY);
  if (prev !== BUILD_ID){
    // Pour ce build: repartir à zéro
    OLD_KEYS.concat(SAVE_KEY).forEach(k => localStorage.removeItem(k));
    localStorage.setItem(BUILD_KEY, BUILD_ID);
  }
})();

// (optionnel) reset manuel ponctuel via l’URL ?reset=1
if (/\breset=1\b/.test(location.search)) {
  OLD_KEYS.concat(SAVE_KEY).forEach(k => localStorage.removeItem(k));
}


function save(){
  const data = { 
    cookies, muted, hanCount,
    upgrades: Object.fromEntries(
      Object.entries(upgrades).map(([k,u]) => [k,{ level:u.level, cost:u.cost }])
    )
  };
  localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}

function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return;
  try{
    const data = JSON.parse(raw);
    if(typeof data.cookies   === 'number') cookies   = data.cookies;
    if(typeof data.muted     === 'boolean') muted     = data.muted;
    if(typeof data.hanCount  === 'number') hanCount  = data.hanCount;
    for (const k of Object.keys(upgrades)){
      if (data.upgrades?.[k]){
        upgrades[k].level = data.upgrades[k].level|0;
        upgrades[k].cost  = Math.max(1, data.upgrades[k].cost|0);
      }
    }
  }catch{
    localStorage.removeItem(SAVE_KEY);
  }
}

  
  function formatCookies(x){ 
    if(x<10000) return nf.format(Math.floor(x));
    const u=["","K","M","Md","Bn","Bd"]; 
    let i=0,n=x; 
    while(n>=1000 && i<u.length-1){n/=1000;i++} 
    return `${n.toFixed(n<10?2:1)}${u[i]}`.replace('.', ','); 
  }
  
  const CLICK_SYNERGY_PER_UP1 = 1;

  const globalMultiplier = ()=> 1 + upgrades.upgrade3.level*(upgrades.upgrade3.multiplier/100);
  
  const cookiesPerClick = ()=> {
    const u1 = upgrades.upgrade1.level;
    const u4 = upgrades.upgrade4.level;
    const base = 1 + u1 * upgrades.upgrade1.multiplier;
    const synergy = u4 * u1 * CLICK_SYNERGY_PER_UP1;
    return (base + synergy) * globalMultiplier();
  };

  const cookiesPerSecond = ()=> {
    const baseProduction = upgrades.upgrade2.level * upgrades.upgrade2.production;
    const hanPenalty = hanCount * HAN_KPS_PENALTY;
    const boostHANBonus = upgrades.upgrade4.level * BOOST_HAN_KPS_INCREASE * upgrades.upgrade2.level;
    return (baseProduction + boostHANBonus) * globalMultiplier() + hanPenalty;
  };

  // ====== UI (throttled) ======
  function updateHUD(){
    currencyDisplay.textContent = `Kippa : ${formatCookies(cookies)}`;
    cpsDisplay.textContent      = `KpS : ${formatCookies(cookiesPerSecond())}`;
    cpcDisplay.textContent      = `Par clic : ${formatCookies(cookiesPerClick())}`;
  }

  function updateHUDThrottled(ts){
    if(!hudDirty || (ts - lastHUDStamp) < HUD_INTERVAL) return;
    lastHUDStamp = ts; hudDirty = false;

    const cText   = `Kippa : ${formatCookies(cookies)}`;
    const cpsText = `KpS : ${formatCookies(cookiesPerSecond())}`;
    const cpcText = `Par clic : ${formatCookies(cookiesPerClick())}`;

    if(currencyDisplay.textContent !== cText)   currencyDisplay.textContent = cText;
    if(cpsDisplay.textContent      !== cpsText) cpsDisplay.textContent      = cpsText;
    if(cpcDisplay.textContent      !== cpcText) cpcDisplay.textContent      = cpcText;
  }

  function updateShopThrottled(ts){
    if(!shopDirty || (ts - lastShopStamp) < SHOP_INTERVAL) return;
    lastShopStamp = ts; shopDirty = false;
    updateShopState();
  }

  (function uiLoop(ts){
    const t = ts || performance.now();
    updateHUDThrottled(t);
    updateShopThrottled(t);
    requestAnimationFrame(uiLoop);
  })();

  function createUpgradeCard(u){
    const card = document.createElement('div');
    card.className='upgrade'; 
    card.id=u.id;
    
    let effectText = '';
    if(u.id === 'upgrade1') effectText = `+${u.multiplier}/clic`;
    else if(u.id === 'upgrade2') effectText = `+${u.production} KpS`;
    else if(u.id === 'upgrade3') effectText = `+${u.multiplier}% global`;
    else if(u.id === 'upgrade4') effectText = `+${BOOST_HAN_KPS_INCREASE} KpS/Rabbi`;
    else if(u.id === 'upgrade5') effectText = `האן`;
    else if(u.id === 'upgrade6') effectText = `Animation 10s`;
    else if(u.id === 'upgrade7') effectText = `Reset des coûts`;

    card.innerHTML = `
      <img src="${u.icon}" alt="${u.name}">
      <div>
        <div class="u-title">${u.name}</div>
        <div class="u-desc">${u.desc}</div>
        <div class="u-meta">
          <span class="badge">Niv. <span class="lv">${u.level}</span></span>
          ${!u.isPassive || u.level > 0 ? `<span class="badge">Effet : ${effectText}</span>` : ''}
          ${u.id === 'upgrade4' && hanCount > 0 ? `<span class="badge" style="background: var(--han-red); color: white;">HAN: ${hanCount}</span>` : ''}
        </div>
      </div>
      <div class="u-actions">
        <div class="price">Coût : <span class="cost">${nf.format(u.cost)}</span></div>
        <button class="buy" aria-label="Acheter ${u.name}">Acheter</button>
      </div>`;
    
    card.querySelector('.buy').addEventListener('click',ev=>{
      const bulk = ev.shiftKey?10:(ev.ctrlKey?'max':1); 
      buyUpgrade(u.id, bulk);
    });
    
    return card;
  }
  
  function renderShop(){ 
    shopEl.querySelectorAll('.upgrade').forEach(n=>n.remove()); 
    for(const u of Object.values(upgrades)) shopEl.appendChild(createUpgradeCard(u)); 
    updateShopState(); 
  }
  
  function updateShopState(){ 
    for(const [id,u] of Object.entries(upgrades)){ 
      const card=document.getElementById(id); 
      if(!card)continue; 
      card.querySelector('.lv').textContent=u.level; 
      card.querySelector('.cost').textContent=nf.format(u.cost); 
      card.querySelector('.buy').disabled = cookies < u.cost;
      
      if(id === 'upgrade4') {
        const hanBadge = card.querySelector('.badge[style*="han-red"]');
        if(hanCount > 0 && !hanBadge) {
          const metaDiv = card.querySelector('.u-meta');
          const newBadge = document.createElement('span');
          newBadge.className = 'badge';
          newBadge.style.cssText = 'background: var(--han-red); color: white;';
          newBadge.textContent = `HAN: ${hanCount}`;
          metaDiv.appendChild(newBadge);
        } else if(hanBadge) {
          hanBadge.textContent = `HAN: ${hanCount}`;
          if(hanCount === 0) hanBadge.remove();
        }
      }
    } 
  }

  // ====== ACHATS ======
  function buyUpgrade(id, bulk=1){
    const u = upgrades[id];
    if(!u) return;

    // PASSIFS
    if(u.isPassive){
      if(id==='upgrade5' && cookies>=u.cost){
        cookies -= u.cost; u.level++;
        convertAllHAN();
        u.cost = Math.max(1, Math.round(u.cost * u.costFactor));
        onStateChange();
        return;
      } else if(id==='upgrade6' && cookies>=u.cost){
        cookies -= u.cost; u.level++;
        startCosmicCelebration();
        u.cost = Math.max(1, Math.round(u.cost * u.costFactor));
        onStateChange();
        return;
      } else if(id==='upgrade7' && cookies>=u.cost){
        cookies -= u.cost; u.level++;
        if(!muted && u.sound){ try{ new Audio(u.sound).play(); }catch{} }
        resetAllCosts('upgrade7');
        playPriceResetFX();
        u.cost = Math.max(1, Math.round(u.cost * u.costFactor));
        onStateChange();
        return;
      }
      return;
    }

    // MAX
    if(bulk==='max'){
      let bought=0, cost=u.cost, factor=u.costFactor;
      while(cookies>=cost){
        cookies -= cost; u.level++;
        if(id==='upgrade2'){ rollHANForNewRabbi(); }
        if(id==='upgrade1') addBackgroundIconUpgrade1();
        if(u.sound){ try{ new Audio(u.sound).play(); }catch{} }
        cost = Math.max(1, Math.round(cost*factor));
        bought++;
      }
      if(bought>0){
        u.cost = cost;
        if(id==='upgrade3') showMegaFlash();
        if(id==='upgrade2') pulseUpgrade2(false);
        if(id==='upgrade4') pulseUpgrade2(true);
        onStateChange();
      }
      return;
    }

    // NORMAL / ×10
    let boughtCount=0;
    for(let i=0;i<bulk;i++){
      if(cookies<u.cost) break;
      cookies -= u.cost; u.level++;
      if(id==='upgrade2'){ rollHANForNewRabbi(); }
      if(id==='upgrade1') addBackgroundIconUpgrade1();
      if(u.sound){ try{ new Audio(u.sound).play(); }catch{} }
      u.cost = Math.max(1, Math.round(u.cost * u.costFactor));
      boughtCount++;
    }

    if(id==='upgrade3' && boughtCount>0) showMegaFlash();
    if(id==='upgrade2' && boughtCount>0) pulseUpgrade2(false);
    if(id==='upgrade4' && boughtCount>0) pulseUpgrade2(true);
    onStateChange();
  }

  function resetAllCosts(excludeId){
    for(const [k, up] of Object.entries(upgrades)){
      if(k === excludeId) continue;
      up.cost = up.baseCost;
    }
    document.querySelectorAll('.upgrade .price .cost').forEach(span=>{
      span.classList.remove('price-reset'); void span.offsetWidth;
      span.classList.add('price-reset');
      setTimeout(()=> span.classList.remove('price-reset'), 900);
    });
  }

  function playPriceResetFX(){
    const fx = document.getElementById('priceResetFX');
    if(!fx) return;
    fx.innerHTML = '<div class="rewind">⏪</div>';
    fx.classList.remove('show'); void fx.offsetWidth;
    fx.classList.add('show');
    setTimeout(()=>{ fx.classList.remove('show'); fx.innerHTML=''; }, 1400);
  }

  function rollHANForNewRabbi(){
    if(upgrades.upgrade4.level === 0){ addOrbitIcon(false); return false; }
    const chance = Math.min(0.1, HAN_SPAWN_CHANCE + 0.02 * upgrades.upgrade4.level);
    if(Math.random() < chance){ hanCount++; addOrbitIcon(true); return true; }
    addOrbitIcon(false); return false;
  }

  function pulseUpgrade2(imgOnly = false) {
    const card = document.getElementById('upgrade2');
    if (!card) return;
    const target = imgOnly ? card.querySelector('img') : card;
    if (!target) return;
    const cls = imgOnly ? 'pulsing-img' : 'pulsing';
    target.classList.remove(cls); void target.offsetWidth;
    target.classList.add(cls);
    setTimeout(()=> target.classList.remove(cls), 800);
  }

  // Conversion des HAN
  function convertAllHAN() {
    if(hanCount === 0) return;
    if(!muted && upgrades.upgrade5?.sound){ try { new Audio(upgrades.upgrade5.sound).play(); } catch {} }
    const hanOrbs = Array.from(orbitLayer.querySelectorAll('.orb.han'));
    hanOrbs.forEach(orb => {
      const icon = orb.querySelector('.orbitIcon');
      icon.style.animation = 'stellarConversion 1s ease-out forwards';
      setTimeout(() => { orb.classList.remove('han'); icon.style.animation = ''; icon.style.filter = ''; }, 1000);
    });
    const msg = document.createElement('div'); msg.className = 'conversionMessage'; msg.textContent = 'כן, תודה רבה'; document.body.appendChild(msg); setTimeout(() => msg.remove(), 1500);
    hanCount = 0; onStateChange();
  }

  // Finale
  function startCosmicCelebration(mp3Url){
    if(celebrationActive) return; celebrationActive = true;
    const overlay = document.createElement('div');
    overlay.id = 'finaleOverlay';
    overlay.innerHTML = `
      <div class="rays"></div>
      <img class="bigIcon" src="${upgrades.upgrade6.hoicone}" alt="Finale">
      <div class="title"><span class="shine">HAN <br>HAN HAN</span></div>
    `;
    document.body.appendChild(overlay);
    const soundUrl = mp3Url || upgrades.upgrade6.sound; 
    let finaleAudio = null;
    if(!muted && soundUrl){ try{ finaleAudio = new Audio(soundUrl); finaleAudio.volume = 1; finaleAudio.play().catch(()=>{}); }catch{} }
    for(let i=0;i<140;i++){ const s=document.createElement('div'); s.className='twinkle'; s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; s.style.animationDelay=(Math.random()*2000)+'ms'; overlay.appendChild(s); }
    const fwTimer = setInterval(()=> spawnFirework(overlay), 500);
    const confTimer = setInterval(()=> spawnConfetti(overlay, 28), 800);
    const credits = document.createElement('div');
    credits.className = 'finaleCredits';
    credits.innerHTML = `
      <h3>— Bravo mon Gourmand ! —</h3>
      <p>…</p>
      <p>Mushlam !</p>
    `;
    overlay.appendChild(credits);
    function spawnFirework(root){
      const fw = document.createElement('div'); fw.className='firework'; const x = (10 + Math.random()*80); const y = (20 + Math.random()*40); fw.style.left = x + '%'; fw.style.top = y + '%';
      const colors = ['#ffd24d','#70b5ff','#9ef0a3','#ff7aa2','#ffffff']; const n = 24;
      for(let i=0;i<n;i++){ const p=document.createElement('div'); p.className='p'; const angle = (i/n) * Math.PI*2; const dist = 80 + Math.random()*80; p.style.setProperty('--dx', Math.cos(angle)*dist+'px'); p.style.setProperty('--dy', Math.sin(angle)*dist+'px'); p.style.color = colors[i%colors.length]; p.style.animationDelay = (Math.random()*120)+'ms'; fw.appendChild(p); }
      root.appendChild(fw); setTimeout(()=>fw.remove(), 1200);
    }
    function spawnConfetti(root, count){ const colors = ['#ffd24d','#70b5ff','#9ef0a3','#ff7aa2','#ffffff']; for(let i=0;i<count;i++){ const c=document.createElement('div'); c.className='confetti'; c.style.left = Math.random()*100+'%'; c.style.top = '-5%'; c.style.setProperty('--c', colors[(Math.random()*colors.length)|0]); c.style.setProperty('--r', (Math.random()*360|0)+'deg'); c.style.animationDelay = (Math.random()*400)+'ms'; root.appendChild(c); setTimeout(()=>c.remove(), 2300); } }
    function cleanup(){ clearInterval(fwTimer); clearInterval(confTimer); try{ if(finaleAudio) finaleAudio.pause(); }catch{} overlay.remove(); celebrationActive = false; }
    const auto = setTimeout(cleanup, 165000);
    overlay.addEventListener('click', ()=>{ clearTimeout(auto); cleanup(); });
    window.addEventListener('keydown', function onKey(e){ if(e.key==='Escape'){ clearTimeout(auto); cleanup(); window.removeEventListener('keydown', onKey); } });
  }

  // ====== INTERACTIONS (optimisées) ======
  function spawnFloat(x,y,txt){
    while (floatLayer.childElementCount >= FLOAT_MAX){
      floatLayer.firstElementChild?.remove();
    }
    const el=document.createElement('div'); 
    el.className='float go'; 
    el.textContent=`+${formatCookies(txt)}`; 
    el.style.left=x+'px'; 
    el.style.top =y+'px';
    el.style.color=Math.random()>.5?'var(--accent)':'var(--accent-2)'; 
    floatLayer.appendChild(el); 
    setTimeout(()=>el.remove(),900);
  }

  function clickCookie(evt){
    const add=cookiesPerClick(); 
    cookies+=add;

    const rect=cookieImg.getBoundingClientRect(); 
    const x=(evt?.clientX ?? (rect.left+rect.width/2)); 
    const y=(evt?.clientY ?? (rect.top+rect.height/2));
    spawnFloat(x,y,add);

    const now = performance.now();
    if (now - lastBurstAt > 120){
      burstCookies(isTouch ? 5 : 8, 2000);
      lastBurstAt = now;
    }

    pulseCookie(); 
    playClick(); 
    onStateChange();
  }

  function pulseCookie(){ 
    cookieImg.style.transform='scale(0.96)'; 
    requestAnimationFrame(()=>{ setTimeout(()=>{cookieImg.style.transform='';},80); }); 
  }

  function playClick(){ 
    if(muted) return; 
    try{ 
      if (!clickSound.paused) clickSound.currentTime = 0;
      clickSound.play(); 
    }catch{} 
  }

  cookieImg.addEventListener('click', clickCookie, {passive:true});
  window.addEventListener('keydown', e=>{ 
    if(e.code==='Space'||e.key===' '){ e.preventDefault(); clickCookie(); }
  });
  muteToggle.addEventListener('change', ()=>{ muted = muteToggle.checked; onStateChange(false) });
  resetBtn.addEventListener('click', ()=>{ 
    if(confirm('Réinitialiser la progression ?')){ 
      cookies=0; muted=false; hanCount=0;
      for(const u of Object.values(upgrades)){ u.level=0; u.cost=u.baseCost; } 
      muteToggle.checked=false; 
      orbitLayer.innerHTML = '';
      onStateChange(); 
    }
  });

  let saveTimer=0;
  function onStateChange(saveNow=true){
    // ➜ laisser le scheduler UI faire le rendu
    markHUD(); 
    markShop();

    if(upgrades.upgrade2.level!==lastOrbitLevel){ 
      syncOrbitIcons(); 
      lastOrbitLevel=upgrades.upgrade2.level; 
    }
    if(upgrades.upgrade1.level!==lastBgCount){ 
      syncBgIcons(); 
      lastBgCount=upgrades.upgrade1.level; 
    }
    // pas de save immédiate (timer + beforeunload)
  }

  // ====== CPS LOOP (léger) ======
  setInterval(()=>{
    cookies += cookiesPerSecond() * (TICK_MS/1000);
    saveTimer += TICK_MS; 
    if(saveTimer>=3000){ save(); saveTimer=0; }
    // Indiquer au scheduler que l'UI est à rafraîchir
    markHUD();
    markShop();
  }, TICK_MS);

  // ====== INIT ======
  function init(){ 
    load(); 
    muteToggle.checked=muted; 
    renderShop(); 
    onStateChange(false); 
    syncBgIcons(); 
    syncOrbitIcons(); 
  }
  init();

  // ====== EFFETS ======
  function burstCookies(count=10, duration=3000){
    const layer=burstLayer; if(!layer) return;
    const frag = document.createDocumentFragment();
    for(let i=0;i<count;i++){
      const img=document.createElement('img'); 
      const size=Math.floor(20+Math.random()*40);
      img.src=cookieImg.src; 
      img.alt='mini cookie'; 
      img.className='miniCookie'; 
      img.style.width=size+'px'; 
      img.style.height=size+'px';
      img.style.left=Math.floor(Math.random()*100)+'%'; 
      img.style.top=Math.floor(Math.random()*100)+'%';
      img.style.setProperty('--burst-duration', duration+'ms'); 
      img.addEventListener('animationend',()=>img.remove());
      frag.appendChild(img);
    }
    layer.appendChild(frag);
  }

  // ====== ORBITES — rayon sécurisé (mobile friendly) ======
  function getOrbitRadius(){
    const wrapRect = cookieWrap?.getBoundingClientRect?.() || {width: cookieImg.width*2, height: cookieImg.height*2};
    const imgRect  = cookieImg.getBoundingClientRect();
    const minHalf  = Math.min(wrapRect.width, wrapRect.height) / 2;
    const margin   = isTouch ? 18 : 28;
    const desired  = (imgRect.width/2) + (isTouch ? 16 : 40);
    const safeMax  = Math.max(0, minHalf - margin - 24);     // 24 ≈ demi-icône
    return Math.max(imgRect.width/2 + 8, Math.min(desired, safeMax));
  }

  function addOrbitIcon(isHAN = false){
    if(!orbitLayer) return;
    const orb = document.createElement('div'); 
    orb.className = 'orb' + (isHAN ? ' han' : '');
	orb.style.zIndex = isHAN ? 10 : 1;
    const img = document.createElement('img'); 
    img.className = 'orbitIcon';

    const rabbiIcon = upgrades.upgrade2.icon;
    const hanIcon   = upgrades.upgrade4.hanIcon || rabbiIcon;
    img.src = isHAN ? hanIcon : rabbiIcon;
    img.alt = isHAN ? 'HAN orbital' : 'Icône production auto';
    
    const angle  = Math.floor(Math.random()*360);
    const speed  = (isHAN ? 20 : 14) + +((Math.random()*(isHAN ? 16 : 12)).toFixed(1));
    const wobble = (1.8 + Math.random()*1.6).toFixed(1);
    const size   = Math.floor(42 + Math.random()*24);

    const baseRadius = getOrbitRadius();
    const wrapRect   = cookieWrap?.getBoundingClientRect?.() || {width:0,height:0};
    const clampMax   = Math.min(wrapRect.width, wrapRect.height)/2 - size/2 - (isTouch ? 6 : 10);

    let desired = (isHAN ? baseRadius * 0.85 : baseRadius) + Math.floor(-24 + Math.random()*18); // -24..-6
    let radius  = Math.max(cookieImg.getBoundingClientRect().width/2 + 6, Math.min(desired, clampMax));

    orb.style.setProperty('--a0', angle+'deg');
    orb.style.setProperty('--speed', speed+'s');
    img.style.setProperty('--size',  size+'px');
    img.style.setProperty('--r',     radius+'px');
    img.style.setProperty('--base-r',baseRadius+'px');
    img.style.setProperty('--wobble',wobble+'s');

    orbitLayer.appendChild(orb); 
    orb.appendChild(img);
  }

  function syncOrbitIcons(){
    const currentHan = orbitLayer.querySelectorAll('.orb.han').length;
    if(currentHan < hanCount){
      for(let i=0; i<(hanCount - currentHan); i++) addOrbitIcon(true);
    }else if(currentHan > hanCount){
      const extras = currentHan - hanCount;
      Array.from(orbitLayer.querySelectorAll('.orb.han')).slice(0, extras).forEach(e => e.remove());
    }
    const level = upgrades.upgrade2.level;
    const normalNeeded = Math.max(0, level - hanCount);
    const totalCurrent = orbitLayer.children.length;
    const normalCurrent = totalCurrent - orbitLayer.querySelectorAll('.orb.han').length;

    if(normalCurrent < normalNeeded){
      for(let i=0; i<(normalNeeded - normalCurrent); i++) addOrbitIcon(false);
    }else if(normalCurrent > normalNeeded){
      const toRemove = normalCurrent - normalNeeded;
      const normals = Array.from(orbitLayer.querySelectorAll('.orb:not(.han)'));
      for(let i=0; i<toRemove && i<normals.length; i++) normals[i].remove();
    }
  }

  function recalibrateOrbitRadii(){
    const base=getOrbitRadius();
    const wrapRect = cookieWrap?.getBoundingClientRect?.() || {width:0,height:0};
    const safeMaxCommon = Math.min(wrapRect.width, wrapRect.height)/2;
    Array.from(orbitLayer.children).forEach(orb=>{
      const img=orb.firstElementChild; 
      if(!img) return;
      const size  = parseInt((img.style.getPropertyValue('--size')||'32').replace('px',''))||32;
      const cur   = parseInt((img.style.getPropertyValue('--r')   ||'0' ).replace('px',''))||base;
      const delta = Math.max(-40, Math.min(40, cur-base));
      let r = base + delta;
      const clampMax = safeMaxCommon - size/2 - (isTouch?6:10);
      r = Math.min(r, clampMax);
      img.style.setProperty('--r', r+'px');
      img.style.setProperty('--base-r', base+'px');
    });
  }
  window.addEventListener('resize', recalibrateOrbitRadii);

  function showMegaFlash(){ 
    if(!megaFlash) return; 
    megaFlash.innerHTML=''; 
    const img=document.createElement('img'); 
    img.src=upgrades.upgrade3.icon; 
    img.alt='Super Boost'; 
    megaFlash.appendChild(img); 
    megaFlash.classList.remove('show'); void megaFlash.offsetWidth; 
    megaFlash.classList.add('show'); 
    setTimeout(()=>{ megaFlash.classList.remove('show'); megaFlash.innerHTML=''; }, 2100); 
  }

  function addBackgroundIconUpgrade1(){ 
    const img=document.createElement('img'); 
    img.className='bgIcon'; 
    img.src=upgrades.upgrade1.icon; 
    img.alt='Multiplicateur';
    img.style.left=Math.floor(Math.random()*100)+'%'; 
    img.style.top =Math.floor(Math.random()*100)+'%';
    img.style.setProperty('--rot', (Math.floor(-20+Math.random()*40))+'deg');
    img.style.setProperty('--scale', (0.5+Math.random()*1.1).toFixed(2));
    img.style.opacity=(0.18+Math.random()*0.6).toFixed(2); 
    bgIconLayer.appendChild(img);
  }

  // Cap décoratif pour éviter un DOM énorme
  function syncBgIcons(){
    const cap = 36;
    const needed = Math.min(cap, upgrades.upgrade1.level|0);
    const current= bgIconLayer.children.length;
    if(current<needed){ 
      for(let i=0;i<needed-current;i++) addBackgroundIconUpgrade1(); 
    } else if(current>needed){ 
      for(let i=current-1;i>=needed;i--) bgIconLayer.children[i].remove(); 
    }
  }
</script>

  
  
</body>
</html>
