<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custom Clicker Game</title>
  <style>
    :root{
      --bg:#056666;--panel:#000000;--card:linear-gradient(150deg,#056666,#0e1218);filter: drop-shadow(0 0 8px #ffd24d) drop-shadow(0 0 18px rgba(255,215,0,.55));
	  --muted:#9aa4b2;--text:#ffffff;--accent:#70b5ff;--accent-2:#9ef0a3;--gold:#ffd24d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0e1218,#056666);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}

body { position: relative; }  /* crée un contexte propre */

#bgIconLayer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;                 /* fond */
}

#gameContainer{
  max-width:1100px;
  margin:0 auto;
  padding:24px;
  position: relative;
  z-index: 1;                 /* au-dessus du fond */
}


    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    header h1{
  font-size:clamp(24px,3.2vw,36px);
  margin:0;
  font-weight:900;
  letter-spacing:.4px;
  line-height:1.1;
  position:relative;

  /* Dégradé blanc -> bleu clair */
  background:linear-gradient(180deg,#ffffff 0%, var(--accent) 100%);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;

  /* Halo doré + bleu clair (léger) */
  text-shadow:
    0 0 8px rgba(255,210,77,.55),
    0 0 22px rgba(112,181,255,.35);

  /* Apparition + respiration */
  animation:titleFade .6s ease-out both, titleGlow 2.6s ease-in-out infinite;
}

/* Soulignement lumineux animé */
header h1::after{
  content:"";
  position:absolute; left:50%; top:100%;
  width:62%; height:3px; border-radius:999px;
  transform:translateX(-50%);
  background:linear-gradient(90deg,transparent, var(--accent), transparent);
  filter:blur(1px);
  animation:underlineGlow 2.6s ease-in-out infinite;
}

/* Keyframes */
@keyframes titleFade{from{opacity:0;transform:translateY(6px) scale(.98)}to{opacity:1;transform:none}}
@keyframes titleGlow{
  0%,100%{text-shadow:0 0 6px rgba(255,210,77,.0),0 0 18px rgba(112,181,255,.0)}
  50%     {text-shadow:0 0 10px rgba(255,210,77,.55),0 0 28px rgba(112,181,255,.45)}
}
@keyframes underlineGlow{0%,100%{opacity:.55}50%{opacity:1}}



    .hud{display:flex;gap:16px;flex-wrap:wrap}
    .pill{background:var(--card);border:1px solid #2a3142;border-radius:999px;padding:8px 14px;font-weight:600}

    .layout{
  display:grid;
  grid-template-columns: minmax(360px,1fr) minmax(280px,.8fr);
  gap:14px;
}

@media (max-width: 800px){
  .layout{ grid-template-columns:1fr; }
}


    .clickZone{background:var(--panel);border:1px solid #2a3142;border-radius:18px;padding:20px;position:relative;overflow:hidden;min-height:clamp(420px, 70vh, 560px) }

    #cookieWrap{position:relative;display:grid;place-items:center;margin-top:8px}
    #cookieImage{width:clamp(160px, 48vmin, 360px);max-width:360px;aspect-ratio:1/1;object-fit:cover;border-radius:50%;cursor:pointer;user-select:none;transition:transform .08s ease, filter .2s ease;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    #cookieImage:active{transform:scale(.96)}
    #cookieImage:hover{filter:saturate(1.05)}

    /* Rotation continue du cookie */
    #cookieSpinner{display:inline-block}
    .spin{animation: cookieSpin var(--spin-speed, 10s) linear infinite;filter: drop-shadow(0 0 1px #056666) drop-shadow(0 0 5px rgba(150,150,150,.55));
;}
    @keyframes cookieSpin{to{transform: rotate(360deg)}}

    /* Icônes en orbite autour du cookie */
    #orbitLayer{position:absolute;left:50%;top:50%;width:0;height:0;pointer-events:none;z-index:3;perspective:800px}
    .orb{position:absolute;left:0;top:0;transform:rotate(var(--a0,0deg));transform-origin:0 0;animation:spinOrbit var(--speed,18s) linear infinite}
    .orbitIcon{
  display:block;
  width:var(--size,32px);
  height:var(--size,32px);
  will-change:transform;
  transform-origin:center;
  animation:wobble var(--wobble,2.6s) ease-in-out infinite;
  filter: drop-shadow(0 0 8px #ffd24d) drop-shadow(0 0 18px rgba(255,215,0,.55));
}

    @keyframes spinOrbit{to{transform:rotate(calc(var(--a0,0deg) + 360deg))}}
    @keyframes wobble{0%{transform:translateX(var(--r,160px)) rotateY(-20deg) scale(.9)}50%{transform:translateX(var(--r,160px)) rotateY(20deg) scale(1.1)}100%{transform:translateX(var(--r,160px)) rotateY(-20deg) scale(.9)}}


    .clickHint{margin-top:8px;color:var(--muted);font-size:14px}

    .controls{position:absolute;inset:auto 12px 12px 12px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--card);border:1px solid #2a3142;color:var(--text);padding:8px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .switch{display:flex;align-items:center;gap:8px;color:var(--muted)}

    .shop{
  background:var(--panel);
  border:1px solid #2a3142;
  border-radius:18px;
  padding:16px;
  max-height:none;     /* ← plus de limite */
  height:auto;         /* ← hauteur selon le contenu */
  overflow:visible;    /* ← pas de scroll interne */
  align-self:start;    /* ← évite l’étirement forcé de la grille */
}

    .shop h2{margin:2px 6px 10px;font-size:18px;color:#c9d7e1}

    .upgrade{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;background:var(--card);border:1px solid #2a3142;border-radius:14px;padding:10px 12px;margin:10px 4px}
    .upgrade img{width:56px;height:56px;border-radius:12px;object-fit:cover}
    .u-title{font-weight:800;letter-spacing:.2px}
    .u-desc{color:var(--muted);font-size:12.5px;margin-top:2px}
    .u-meta{display:flex;gap:10px;margin-top:6px;color:#c9d7e1;font-size:13px}
    .u-actions{display:flex;flex-direction:column;align-items:end;gap:8px}
    .price{font-weight:800}
    .buy{background:linear-gradient(180deg,#2a6fff,#1a57e0);border:none;padding:8px 12px;border-radius:10px;color:white;font-weight:800;cursor:pointer}
    .buy[disabled]{background:#2b3550;opacity:.6}

    /* Floating +N text */
    .float{position:absolute;left:0;top:0;pointer-events:none;translate:-50% -50%;font-weight:800;text-shadow:0 2px 8px rgba(0,0,0,.5)}
    .float.go{animation:rise .9s ease-out forwards}
    @keyframes rise{0%{opacity:0;transform:translateY(0) scale(.9)}10%{opacity:1}100%{opacity:0;transform:translateY(-80px) scale(1.1)}}

    /* Mini-cookies burst */
    #burstLayer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .miniCookie{position:absolute;opacity:0;animation:popFade var(--burst-duration,3s) ease-out forwards;will-change:transform,opacity;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
    @keyframes popFade{0%{opacity:0;transform:translateY(0) scale(.6) rotate(0)}10%{opacity:1}100%{opacity:0;transform:translateY(-20px) scale(1) rotate(360deg)}}


/* Mega flash (Upgrade 3) */
#megaFlash{position:fixed;inset:0;pointer-events:none;z-index:10000;display:none}
#megaFlash.show{display:block;animation:fadeAll 4s ease-out forwards}
#megaFlash::before{
  content:"";position:absolute;inset:-20vmax;opacity:.9;filter:blur(8px);
  background:conic-gradient(from 0deg,
    rgba(255,215,0,.0) 0 10deg,
    rgba(255,215,0,.35) 10deg 12deg,
    transparent 12deg 20deg);
  animation:spin 1.2s linear infinite
}
#megaFlash img{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%) scale(.2);
  width:min(70vmin,800px);height:auto;
  filter:drop-shadow(0 0 30px rgba(255,215,0,.9)) drop-shadow(0 0 80px rgba(255,215,0,.6));
  animation:boom 4s cubic-bezier(.2,.8,.2,1) forwards
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes boom{
  0%{transform:translate(-50%,-50%) scale(.2)}
  70%{transform:translate(-50%,-50%) scale(1.12)}
  100%{transform:translate(-50%,-50%) scale(1)}
}
@keyframes fadeAll{0%{opacity:0}15%{opacity:1}100%{opacity:0}}

/* Icônes de l'upgrade 1 en arrière-plan */

.bgIcon{
  position:absolute;
  width:100px; height:auto;
  opacity:.08;                 /* opacité faible */
  filter:blur(0.8px);          /* léger flou */
  transform:translate(-50%,-50%) rotate(var(--rot,0deg)) scale(var(--scale,1));
}



    /* Small helper badges */
    .badge{background:#223048;border:1px solid #2a3142;border-radius:8px;padding:2px 6px;font-size:11px;color:#c9d7e1}

    footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div id="bgIconLayer" aria-hidden="true"></div>
  <div id="gameContainer">
    <header>
      <h1>Yehudi Clicker</h1>
      <div class="hud">
        <div id="currencyDisplay" class="pill" aria-live="polite">Kippas : 0</div>
        <div id="cpsDisplay" class="pill">CPS : 0</div>
        <div id="cpcDisplay" class="pill">Par clic : 1</div>
      </div>
    </header>

    <div class="layout">
      <section class="clickZone" aria-label="Zone de clic">
        <div id="cookieWrap">
          <!-- Remplacez la source ci-dessous par votre image principale -->
          <div id="cookieSpinner" class="spin"><img id="cookieImage" src="https://i.postimg.cc/dVRtQ1xP/kippa.png" alt="Grosse Kippa cliquable" /></div>
          <div class="clickHint">Cliquez sur la Kippa — appuyez sur <kbd>Espace</kbd> aussi !</div>
          <div id="orbitLayer" aria-hidden="true"></div>
        </div>

        <div class="controls">
          <button id="resetBtn" class="btn" title="Réinitialiser la progression">Réinitialiser</button>
          <label class="switch"><input type="checkbox" id="muteToggle" /> Muet</label>
          <span class="badge" id="saveBadge" title="Sauvegarde automatique">Sauvegarde auto</span>
        </div>

        <!-- Effet +N flottant -->
        <div id="floatLayer" aria-hidden="true"></div>

        <!-- Mini-cookies burst overlay -->
        <div id="burstLayer" aria-hidden="true"></div>
		
		<div id="megaFlash" aria-hidden="true"></div>
		
		<div id="bgIconLayer" aria-hidden="true"></div>


        <!-- Remplacez la source ci-dessous par votre effet sonore -->
        <audio id="clickSound" src="https://han-han-boop.github.io/Mushlam/Kes.mp3" preload="auto"></audio>
      </section>

      <aside class="shop" id="shop" aria-label="Boutique">
        <h2>Boutique</h2>
        <!-- Les cartes d’upgrade sont générées par JavaScript -->
      </aside>
    </div>

    <footer>
      <span class="badge">Conseil : Maj-clic = x10 | Ctrl-clic = acheter max</span>
    </footer>
  </div>

  <script>
    // ==========================
    //  CONFIG / ÉQUILIBRAGE
    // ==========================
    // Modifiez librement ces valeurs pour équilibrer votre jeu.
    const COST_FACTOR_DEFAULT = 1.25;            // Facteur d’augmentation des coûts standard
    const TICK_MS = 250;                        // Intervalle de production automatique (plus fluide que 1000ms)

    // ==========================
    //  ÉTAT DU JEU
    // ==========================
    let cookies = 0;
    let muted = false;
    let lastOrbitLevel = -1;
	let lastBgCount = -1;


    // Trois améliorations de base
    // upgrade1: bonus par CLIC (additif)
    // upgrade2: production AUTOMATIQUE (CPS)
    // upgrade3: BOOST GLOBAL (multiplicatif en %)
    const upgrades = {
      upgrade1: {
        id: 'upgrade1',
        name: 'Synagogue',
        desc: 'Augmente les Kippas gagnés par clic.',
        icon: 'https://i.postimg.cc/gJxx0phV/synagogue.png',
		sound: 'https://han-han-boop.github.io/Mushlam/Mushlam.mp3',
        level: 0,
        baseCost: 2,
        cost: 2,
        costFactor: COST_FACTOR_DEFAULT,
        multiplier: 1 // +1 cookie par niveau et par clic
      },
      upgrade2: {
        id: 'upgrade2',
        name: 'Rabbin',
        desc: 'Produit des Kippas automatiquement (KpS).',
        icon: 'https://i.postimg.cc/C5Ddj4md/Rabbin.png',
		sound: 'https://han-han-boop.github.io/Mushlam/ashk.mp3',
        level: 0,
        baseCost: 25,
        cost: 25,
        costFactor: COST_FACTOR_DEFAULT,
        production: 5 // +1 CPS par niveau
      },
      upgrade3: {
        id: 'upgrade3',
        name: 'Le Peuple Elu',
        desc: 'Augmente toutes les productions de 25% par niveau.',
        icon: 'https://i.postimg.cc/k5c4s4QF/elu.png',
		sound: 'https://han-han-boop.github.io/Mushlam/Ye.mp3',
        level: 0,
        baseCost: 50,
        cost: 50,
        costFactor: 1.3, // un peu plus cher
        multiplier: 25 // % par niveau
      }
    };

    // ==========================
    //  UTILITAIRES
    // ==========================
    const nf = new Intl.NumberFormat('fr-FR');
    const shopEl = document.getElementById('shop');
    const cookieImg = document.getElementById('cookieImage');
    const currencyDisplay = document.getElementById('currencyDisplay');
    const cpsDisplay = document.getElementById('cpsDisplay');
    const cpcDisplay = document.getElementById('cpcDisplay');
    const clickSound = document.getElementById('clickSound');
    const floatLayer = document.getElementById('floatLayer');
    const burstLayer = document.getElementById('burstLayer');
	const megaFlash = document.getElementById('megaFlash');
    const orbitLayer = document.getElementById('orbitLayer');
    const muteToggle = document.getElementById('muteToggle');
    const resetBtn = document.getElementById('resetBtn');
	const bgIconLayer = document.getElementById('bgIconLayer');


    function save(){
      const data = {
        cookies,
        muted,
        upgrades: Object.fromEntries(Object.entries(upgrades).map(([k,u])=>[k,{
          level:u.level, cost:u.cost
        }]))
      };
      localStorage.setItem('cookie-clicker-save', JSON.stringify(data));
    }

    function load(){
      const raw = localStorage.getItem('cookie-clicker-save');
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        if(typeof data.cookies === 'number') cookies = data.cookies;
        if(typeof data.muted === 'boolean') muted = data.muted;
        for(const key of Object.keys(upgrades)){
          if(data.upgrades?.[key]){
            upgrades[key].level = data.upgrades[key].level|0;
            upgrades[key].cost = Math.max(1, data.upgrades[key].cost|0);
          }
        }
      }catch(e){
        console.warn('Save illisible, réinitialisation.');
        localStorage.removeItem('cookie-clicker-save');
      }
    }

    function formatCookies(x){
      if(x < 10000) return nf.format(Math.floor(x));
      const units = ["", "K", "M", "Md", "Bn", "Bd"];
      let u = 0; let n = x;
      while(n >= 1000 && u < units.length-1){n/=1000;u++;}
      return `${n.toFixed(n<10?2:1)}${units[u]}`.replace('.', ',');
    }

    function globalMultiplier(){
      return 1 + (upgrades.upgrade3.level * (upgrades.upgrade3.multiplier/100));
    }

    function cookiesPerClick(){
      const base = 1;
      const add = upgrades.upgrade1.level * upgrades.upgrade1.multiplier;
      return (base + add) * globalMultiplier();
    }

    function cookiesPerSecond(){
      const base = upgrades.upgrade2.level * upgrades.upgrade2.production;
      return base * globalMultiplier();
    }

    // ==========================
    //  AFFICHAGE
    // ==========================
    function updateHUD(){
      currencyDisplay.textContent = `Kippa : ${formatCookies(cookies)}`;
      cpsDisplay.textContent = `Kippa par seconde : ${formatCookies(cookiesPerSecond())}`;
      cpcDisplay.textContent = `Kippa par clic : ${formatCookies(cookiesPerClick())}`;
    }

    function createUpgradeCard(u){
      const card = document.createElement('div');
      card.className = 'upgrade';
      card.id = u.id;
      card.innerHTML = `
        <img src="${u.icon}" alt="${u.name}" />
        <div>
          <div class="u-title">${u.name}</div>
          <div class="u-desc">${u.desc}</div>
          <div class="u-meta">
            <span class="badge">Niv. <span class="lv">${u.level}</span></span>
            <span class="badge">Effet : ${u.id==='upgrade1'?`+${u.multiplier}/clic`:(u.id==='upgrade2'?`+${u.production} KpS`:`+${u.multiplier}% global`)}</span>
          </div>
        </div>
        <div class="u-actions">
          <div class="price">Coût : <span class="cost">${nf.format(u.cost)}</span></div>
          <button class="buy" aria-label="Acheter ${u.name}">Acheter</button>
        </div>
      `;

      const buyBtn = card.querySelector('.buy');
      buyBtn.addEventListener('click', (ev)=>{
        const bulk = ev.shiftKey ? 10 : (ev.ctrlKey ? 'max' : 1);
        buyUpgrade(u.id, bulk);
      });

      return card;
    }

    function renderShop(){
      shopEl.querySelectorAll('.upgrade').forEach(n=>n.remove());
      for(const u of Object.values(upgrades)){
        const card = createUpgradeCard(u);
        shopEl.appendChild(card);
      }
      updateShopState();
    }

    function updateShopState(){
      for(const [id,u] of Object.entries(upgrades)){
        const card = document.getElementById(id);
        if(!card) continue;
        card.querySelector('.lv').textContent = u.level;
        card.querySelector('.cost').textContent = nf.format(u.cost);
        const btn = card.querySelector('.buy');
        btn.disabled = cookies < u.cost;
      }
    }

//  LOGIQUE D’ACHAT
function buyUpgrade(id, bulk=1){
  const u = upgrades[id];
  if(!u) return;

  if(bulk === 'max'){
    // Acheter le maximum possible
    let bought = 0;
    let cost = u.cost;
    const factor = u.costFactor;
    while(cookies >= cost){
      cookies -= cost;
      u.level++;
	  if(id==='upgrade1') addBackgroundIconUpgrade1();
      bought++;
      if (u.sound) new Audio(u.sound).play();        // ✅ son à chaque achat
      cost = Math.max(1, Math.round(cost * factor));
    }
    if(bought>0){
      u.cost = cost;
      if(id==='upgrade3') showMegaFlash();           // ✅ flash si upgrade3
      onStateChange();
    }
    return;
  }

  let boughtCount = 0;                               // ✅ déclaré AVANT la boucle
  for(let i=0;i<bulk;i++){
    if(cookies < u.cost) break;
    cookies -= u.cost;
    u.level++;
	if(id==='upgrade1') addBackgroundIconUpgrade1();
    boughtCount++;                                   // ✅ incrémenté à chaque achat
    if (u.sound) new Audio(u.sound).play();          // ✅ son à chaque achat
    u.cost = Math.max(1, Math.round(u.cost * u.costFactor));
  }
  if(id==='upgrade3' && boughtCount>0) showMegaFlash(); // ✅ flash si upgrade3 acheté
  onStateChange();
}


    // ==========================
    //  INTERACTIONS
    // ==========================
    function spawnFloat(x,y,txt){
      const el = document.createElement('div');
      el.className = 'float go';
      el.textContent = `+${formatCookies(txt)}`;
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      el.style.color = Math.random()>.5? 'var(--accent)':'var(--accent-2)';
      floatLayer.appendChild(el);
      setTimeout(()=>el.remove(), 900);
    }

    function clickCookie(evt){
      const add = cookiesPerClick();
      cookies += add;
      const rect = cookieImg.getBoundingClientRect();
      const x = (evt?.clientX ?? (rect.left + rect.width/2));
      const y = (evt?.clientY ?? (rect.top + rect.height/2));
      spawnFloat(x, y, add);
      burstCookies(10, 3000);
      pulseCookie();
      playClick();
      onStateChange();
    }

    function pulseCookie(){
      cookieImg.style.transform = 'scale(0.96)';
      requestAnimationFrame(()=>{
        setTimeout(()=>{cookieImg.style.transform='';}, 80);
      });
    }

    function playClick(){
      if(muted) return;
      try{
        clickSound.currentTime = 0;
        clickSound.play();
      }catch(e){/* lecture bloquée par navigateur, ignorer */}
    }

    cookieImg.addEventListener('click', clickCookie);
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space' || e.key === ' '){
        e.preventDefault();
        clickCookie();
      }
    });

    muteToggle.addEventListener('change', ()=>{ muted = muteToggle.checked; onStateChange(false); });

    resetBtn.addEventListener('click', ()=>{
      if(confirm('Réinitialiser la progression ?')){
        cookies = 0; muted = false;
        for(const u of Object.values(upgrades)){
          u.level = 0; u.cost = u.baseCost;
        }
        muteToggle.checked = false;
        onStateChange();
      }
    });

    let saveTimer = 0;
    function onStateChange(saveNow=true){
      updateHUD();
      updateShopState();
      if (upgrades.upgrade2.level !== lastOrbitLevel) { syncOrbitIcons(); lastOrbitLevel = upgrades.upgrade2.level; }
      if(saveNow) save();
	  if (upgrades.upgrade1.level !== lastBgCount) { 
  syncBgIcons(); 
  lastBgCount = upgrades.upgrade1.level; 
}

    }

    // ==========================
    //  BOUCLE DE JEU (CPS)
    // ==========================
    let lastTick = performance.now();
    setInterval(()=>{
      const now = performance.now();
      const dt = (now - lastTick)/1000; // en secondes
      lastTick = now;
      const cps = cookiesPerSecond();
      cookies += cps * (TICK_MS/1000);
      // sauvegarde throttlée
      saveTimer += TICK_MS;
      if(saveTimer >= 3000){ save(); saveTimer = 0; }
      updateHUD();
      updateShopState();
    }, TICK_MS);

    // ==========================
    //  INITIALISATION
    // ==========================
    function init(){
      load();
      muteToggle.checked = muted;
      renderShop();
      onStateChange(false);
	  syncBgIcons();
      syncOrbitIcons();
    }
    init();
  // Mini-cookies burst effect
  function burstCookies(count=10, duration=3000){
    const layer = document.getElementById('burstLayer');
    if(!layer) return;
    for(let i=0;i<count;i++){
      const img = document.createElement('img');
      const size = Math.floor(20 + Math.random()*40);
      img.src = cookieImg.src;
      img.alt = 'mini cookie';
      img.className = 'miniCookie';
      img.style.width = size + 'px';
      img.style.height = size + 'px';
      img.style.left = Math.floor(Math.random()*100) + '%';
      img.style.top = Math.floor(Math.random()*100) + '%';
      img.style.setProperty('--burst-duration', duration + 'ms');
      layer.appendChild(img);
      img.addEventListener('animationend', ()=> img.remove());
    }
  }

  // Icônes en orbite (autour du cookie)
  function getOrbitRadius(){
    const rect = cookieImg.getBoundingClientRect();
    return Math.round(rect.width/2) + 50; // rayon de base en px
  }

  function addOrbitIcon(){
    if(!orbitLayer) return;
    const orb = document.createElement('div');
    orb.className = 'orb';

    const img = document.createElement('img');
    img.className = 'orbitIcon';
    img.src = upgrades.upgrade2.icon || '[CHEMIN_ICONE_UPGRADE2.PNG]';
    img.alt = 'Icône production auto';

    const angle = Math.floor(Math.random()*360);
    const speed = (14 + Math.random()*12).toFixed(1); // 14s à 26s
    const wobble = (1.8 + Math.random()*1.6).toFixed(1); // 1.8s à 3.4s
    const size = Math.floor(45 + Math.random()*25); // 22px à 40px
    const radius = getOrbitRadius() + Math.floor(-70 + Math.random()*60); // +-20px autour du rayon de base

    orb.style.setProperty('--a0', angle + 'deg');
    orb.style.setProperty('--speed', speed + 's');

    img.style.setProperty('--size', size + 'px');
    img.style.setProperty('--r', radius + 'px');
    img.style.setProperty('--wobble', wobble + 's');

    orbitLayer.appendChild(orb);
    orb.appendChild(img);
  }

  function syncOrbitIcons(){
    if(!orbitLayer) return;
    const needed = (upgrades.upgrade2.level|0);
    const current = orbitLayer.children.length;
    if(current < needed){
      for(let i=0;i<needed-current;i++) addOrbitIcon();
    } else if(current > needed){
      for(let i=current-1;i>=needed;i--) orbitLayer.children[i].remove();
    }
  }

  function recalibrateOrbitRadii(){
    if(!orbitLayer) return;
    const base = getOrbitRadius();
    Array.from(orbitLayer.children).forEach(orb=>{
      const img = orb.firstElementChild; if(!img) return;
      const cur = parseInt((img.style.getPropertyValue('--r')||'0').replace('px',''))||base;
      const delta = Math.max(-40, Math.min(40, cur - base));
      img.style.setProperty('--r', (base + delta) + 'px');
    });
  }
  window.addEventListener('resize', recalibrateOrbitRadii);
  
  function showMegaFlash(){
  if(!megaFlash) return;
  megaFlash.innerHTML = '';
  const img = document.createElement('img');
  img.src = upgrades?.upgrade3?.icon || '[CHEMIN_ICONE_UPGRADE3.PNG]';
  img.alt = 'Super Boost';
  megaFlash.appendChild(img);
  megaFlash.classList.remove('show');
  void megaFlash.offsetWidth;   // reset animation
  megaFlash.classList.add('show');
  setTimeout(()=>{ megaFlash.classList.remove('show'); megaFlash.innerHTML=''; }, 2100);
}


function addBackgroundIconUpgrade1(){
  if(!bgIconLayer) return;
  const img = document.createElement('img');
  img.className = 'bgIcon';
  img.src = upgrades?.upgrade1?.icon || '[CHEMIN_ICONE_UPGRADE1.PNG]';
  img.alt = 'Multiplicateur';

  // Position aléatoire
  img.style.left = Math.floor(Math.random()*100) + '%';
  img.style.top  = Math.floor(Math.random()*100) + '%';

  // Inclinaison -20° à +20° (autour de l’axe vertical visuel)
  const rot = Math.floor(-20 + Math.random()*40);
  img.style.setProperty('--rot', rot + 'deg');

  // Taille ±15% autour de 50px
  const scale = (0.5 + Math.random()*1.1).toFixed(2);
  img.style.setProperty('--scale', scale);

  // Opacité un peu variable
  img.style.opacity = (0.18 + Math.random()*0.6).toFixed(2);

  bgIconLayer.appendChild(img);
}


function syncBgIcons(){
  if(!bgIconLayer) return;
  const needed = upgrades.upgrade1.level|0;
  const current = bgIconLayer.children.length;
  if(current < needed){
    for(let i=0;i<needed-current;i++) addBackgroundIconUpgrade1();
  } else if(current > needed){
    for(let i=current-1;i>=needed;i--) bgIconLayer.children[i].remove();
  }
}


</script>
</body>
</html>
