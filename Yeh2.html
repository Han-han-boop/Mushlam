<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custom Clicker Game</title>
  <style>
    :root{
      --bg:#056666; --panel:#000000; --card:linear-gradient(150deg,#056666,#0e1218);
      --muted:#9aa4b2; --text:#ffffff; --accent:#70b5ff; --accent-2:#9ef0a3; --gold:#ffd24d;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--text);
      background:linear-gradient(180deg,#0e1218,#056666);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      position:relative;
      -webkit-tap-highlight-color:transparent;
      padding-bottom:env(safe-area-inset-bottom);
    }

    /* BG icons (upgrade1) — une seule couche */
    #bgIconLayer{ position:fixed; inset:0; pointer-events:none; z-index:0 }

    #gameContainer{ max-width:1100px; margin:0 auto; padding:24px; position:relative; z-index:1 }

    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px }
    header h1{
      font-size:clamp(24px,3.2vw,36px); margin:0; font-weight:900; letter-spacing:.4px; line-height:1.1; position:relative;
      background:linear-gradient(180deg,#fff 0%, var(--accent) 100%); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 8px rgba(255,210,77,.55), 0 0 22px rgba(112,181,255,.35);
      animation:titleFade .6s ease-out both, titleGlow 2.6s ease-in-out infinite;
    }
    header h1::after{
      content:""; position:absolute; left:50%; top:100%; width:62%; height:3px; border-radius:999px;
      transform:translateX(-50%); background:linear-gradient(90deg,transparent,var(--accent),transparent);
      filter:blur(1px); animation:underlineGlow 2.6s ease-in-out infinite;
    }
    @keyframes titleFade{ from{opacity:0;transform:translateY(6px) scale(.98)} to{opacity:1;transform:none} }
    @keyframes titleGlow{ 0%,100%{text-shadow:0 0 6px rgba(255,210,77,0),0 0 18px rgba(112,181,255,0)} 50%{text-shadow:0 0 10px rgba(255,210,77,.55),0 0 28px rgba(112,181,255,.45)} }
    @keyframes underlineGlow{ 0%,100%{opacity:.55} 50%{opacity:1} }

    .hud{ display:flex; gap:16px; flex-wrap:wrap }
    .pill{ background:var(--card); border:1px solid #2a3142; border-radius:999px; padding:8px 14px; font-weight:600 }

    /* ===== Desktop (inchangé) ===== */
    .layout{ display:grid; grid-template-columns:minmax(360px,1fr) minmax(280px,.8fr); gap:14px }

    .clickZone{
      background:var(--panel); border:1px solid #2a3142; border-radius:18px; padding:20px;
      position:relative; overflow:hidden; min-height:clamp(420px, 70vh, 560px);
    }

    #cookieWrap{ position:relative; display:grid; place-items:center; margin-top:8px }

    #cookieImage{
      width:clamp(160px, 48vmin, 360px); max-width:360px; aspect-ratio:1/1; object-fit:cover; border-radius:50%;
      cursor:pointer; user-select:none; transition:transform .08s ease, filter .2s ease; box-shadow:0 10px 30px rgba(0,0,0,.45);
      touch-action:manipulation;
    }
    #cookieImage:active{ transform:scale(.96) }
    #cookieImage:hover{ filter:saturate(1.05) }

    #cookieSpinner{ display:inline-block }
    .spin{ animation: cookieSpin var(--spin-speed, 10s) linear infinite; filter:drop-shadow(0 0 1px #056666) drop-shadow(0 0 5px rgba(150,150,150,.55)) }
    @keyframes cookieSpin{ to{ transform:rotate(360deg) } }

    /* Orbites */
    #orbitLayer{ position:absolute; left:50%; top:50%; width:0; height:0; pointer-events:none; z-index:3; perspective:800px }
    .orb{ position:absolute; left:0; top:0; transform:rotate(var(--a0,0deg)); transform-origin:0 0; animation:spinOrbit var(--speed,18s) linear infinite }
    .orbitIcon{
      display:block; width:var(--size,32px); height:var(--size,32px); will-change:transform; transform-origin:center;
      animation:wobble var(--wobble,2.6s) ease-in-out infinite;
      filter: drop-shadow(0 0 8px #ffd24d) drop-shadow(0 0 18px rgba(255,215,0,.55));
    }
    @keyframes spinOrbit{ to{ transform:rotate(calc(var(--a0,0deg) + 360deg)) } }
    @keyframes wobble{ 0%{transform:translateX(var(--r,160px)) rotateY(-20deg) scale(.9)} 50%{transform:translateX(var(--r,160px)) rotateY(20deg) scale(1.1)} 100%{transform:translateX(var(--r,160px)) rotateY(-20deg) scale(.9)} }

    .clickHint{ margin-top:8px; color:var(--muted); font-size:14px }

    .controls{ position:absolute; inset:auto 12px 12px 12px; display:flex; gap:10px; flex-wrap:wrap }
    .btn{ background:var(--card); border:1px solid #2a3142; color:var(--text); padding:8px 12px; border-radius:12px; font-weight:600; cursor:pointer; touch-action:manipulation }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .switch{ display:flex; align-items:center; gap:8px; color:var(--muted) }

    .shop{
      background:var(--panel); border:1px solid #2a3142; border-radius:18px; padding:16px;
      max-height:none; height:auto; overflow:visible; align-self:start;
    }
    .shop h2{ margin:2px 6px 10px; font-size:18px; color:#c9d7e1 }

    .upgrade{ display:grid; grid-template-columns:56px 1fr auto; gap:12px; align-items:center; background:var(--card); border:1px solid #2a3142; border-radius:14px; padding:10px 12px; margin:10px 4px }
    .upgrade img{ width:56px; height:56px; border-radius:12px; object-fit:cover }
    .u-title{ font-weight:800; letter-spacing:.2px }
    .u-desc{ color:var(--muted); font-size:12.5px; margin-top:2px }
    .u-meta{ display:flex; gap:10px; margin-top:6px; color:#c9d7e1; font-size:13px }
    .u-actions{ display:flex; flex-direction:column; align-items:end; gap:8px }
    .price{ font-weight:800 }
    .buy{ background:linear-gradient(180deg,#2a6fff,#1a57e0); border:none; padding:8px 12px; border-radius:10px; color:white; font-weight:800; cursor:pointer; touch-action:manipulation }
    .buy[disabled]{ background:#2b3550; opacity:.6 }

    /* +N flottant */
    .float{ position:absolute; left:0; top:0; pointer-events:none; translate:-50% -50%; font-weight:800; text-shadow:0 2px 8px rgba(0,0,0,.5) }
    .float.go{ animation:rise .9s ease-out forwards }
    @keyframes rise{ 0%{opacity:0;transform:translateY(0) scale(.9)} 10%{opacity:1} 100%{opacity:0;transform:translateY(-80px) scale(1.1)} }

    /* mini-cookies */
    #burstLayer{ position:fixed; inset:0; pointer-events:none; z-index:4 }
    .miniCookie{ position:absolute; opacity:0; animation:popFade var(--burst-duration,3s) ease-out forwards; will-change:transform,opacity; filter:drop-shadow(0 2px 6px rgba(0,0,0,.45)) }
    @keyframes popFade{ 0%{opacity:0;transform:translateY(0) scale(.6) rotate(0)} 10%{opacity:1} 100%{opacity:0;transform:translateY(-20px) scale(1) rotate(360deg)} }

    /* Mega flash (Upgrade 3) — centré écran */
    #megaFlash{ position:fixed; inset:0; pointer-events:none; z-index:2147483000; display:none }
    #megaFlash.show{ display:block; animation:fadeAll 2.2s ease-out forwards }
    #megaFlash::before{
      content:""; position:fixed; inset:-20vmax; opacity:.9; filter:blur(8px);
      background:conic-gradient(from 0deg, rgba(255,215,0,0) 0 10deg, rgba(255,215,0,.35) 10deg 12deg, transparent 12deg 20deg);
      animation:spin 1s linear infinite;
    }
    #megaFlash img{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.2);
      width:min(72vmin,820px); height:auto; filter:drop-shadow(0 0 30px rgba(255,215,0,.9)) drop-shadow(0 0 80px rgba(255,215,0,.6));
      animation:boom 2.2s cubic-bezier(.2,.8,.2,1) forwards; will-change:transform,opacity;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    @keyframes boom{ 0%{transform:translate(-50%,-50%) scale(.2)} 70%{transform:translate(-50%,-50%) scale(1.12)} 100%{transform:translate(-50%,-50%) scale(1)} }
    @keyframes fadeAll{ 0%{opacity:0} 15%{opacity:1} 100%{opacity:0} }

    /* Icônes upgrade1 en background */
    .bgIcon{
      position:absolute; width:100px; height:auto; opacity:.08; filter:blur(.8px);
      transform:translate(-50%,-50%) rotate(var(--rot,0deg)) scale(var(--scale,1));
    }

    .badge{ background:#223048; border:1px solid #2a3142; border-radius:8px; padding:2px 6px; font-size:11px; color:#c9d7e1 }
    footer{ margin-top:16px; color:var(--muted); font-size:12px; text-align:center }

    /* ===== MOBILE (design soigné + centrage parfait) ===== */
    @media (max-width: 800px){
      html{ font-size:106% }
      :root{ --panel:rgba(14,18,24,.72); --card:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)) }
      body{
        background:radial-gradient(1200px 600px at 50% -10%, #12304a 0%, #0e1218 38%, #0b0e13 100%);
        background-attachment:fixed;
      }

      .layout{ grid-template-columns:1fr !important; gap:16px }
      #gameContainer{ padding:16px }

      header{ flex-direction:column; align-items:center; gap:10px; text-align:center }
      header h1{ font-size:clamp(22px,7vw,28px); text-shadow:0 0 6px rgba(255,210,77,.35), 0 0 12px rgba(112,181,255,.25) }
      header h1::after{ width:46%; height:2px }

      .hud{ width:100%; display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
      .pill{
        padding:10px 12px; border-radius:14px;
        background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.14);
        box-shadow:0 6px 20px rgba(0,0,0,.25) inset, 0 2px 12px rgba(0,0,0,.18);
        text-align:center;
      }

      .clickZone{
        display:grid; grid-template-rows:1fr auto; align-items:center;
        min-height:clamp(520px,74dvh,740px);
        backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.12); box-shadow:0 14px 38px rgba(0,0,0,.35);
        padding:16px 12px;
      }
      #cookieWrap{
        margin-top:0;
        position:relative; display:flex; align-items:center; justify-content:center;
        min-height:clamp(380px,62dvh,620px); align-self:stretch;
      }
      #cookieImage{ width:clamp(200px,62vmin,360px); box-shadow:0 10px 26px rgba(0,0,0,.35); margin-top:6px }
      #orbitLayer{ perspective:700px }
      .orbitIcon{ filter:drop-shadow(0 0 6px rgba(255,210,77,.45)) }

      .clickHint{
        position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
        margin:0; font-size:13px; opacity:.9;
      }

      .controls{
        position:static; inset:auto; margin:14px 0 0; align-self:end; justify-content:center; gap:10px;
        background:rgba(10,12,18,.45); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:8px; backdrop-filter:blur(8px);
      }
      .btn,.buy,button{ min-height:48px; padding:12px 16px; font-size:16px; border-radius:14px; box-shadow:0 4px 16px rgba(0,0,0,.25) }

      .shop{ padding:14px; border:1px solid rgba(255,255,255,.12); backdrop-filter:blur(6px) }
      .shop h2{ margin:4px 0 8px; font-size:18px; color:#e5f2ff; text-align:center }
      .upgrade{
        grid-template-columns:56px 1fr; gap:12px; align-items:center;
        background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.14); border-radius:16px; padding:12px; margin:10px 2px; box-shadow:0 8px 24px rgba(0,0,0,.28);
      }
      .u-actions{ grid-column:1 / -1; align-items:stretch }
      .price{ font-size:16px }
      .buy{ width:100%; background:linear-gradient(180deg,#3292ff,#1c62ea); border:1px solid rgba(255,255,255,.2); color:#fff; font-weight:800; text-shadow:0 1px 0 rgba(0,0,0,.25) }
      .buy:active{ transform:translateY(1px) scale(.98) }
      .buy[disabled]{ background:#2b3550; opacity:.7 }

      /* effets un peu plus light */
      .spin{ --spin-speed:12s }
      .miniCookie{ filter:drop-shadow(0 1px 4px rgba(0,0,0,.35)) }

      /* over-layers jamais cliquables */
      #bgIconLayer,#burstLayer,#megaFlash{ pointer-events:none !important }
    }

    /* Cibles tactiles / pas de hover */
    @media (pointer:coarse){ .upgrade,.btn,.buy{ min-height:48px } }
    @media (hover:none){ .hover-only,.tooltip-on-hover{ display:none } }

    /* Accessibilité : réduire les animations */
    @media (prefers-reduced-motion:reduce){
      *,*::before,*::after{ animation:none !important; transition-duration:.01ms !important }
    }
  </style>
</head>
<body>
  <!-- BG icons (upgrade1) -->
  <div id="bgIconLayer" aria-hidden="true"></div>
  <!-- Mega flash global (au centre de l’écran) -->
  <div id="megaFlash" aria-hidden="true"></div>

  <div id="gameContainer">
    <header>
      <h1>Yehudi Clicker</h1>
      <div class="hud">
        <div id="currencyDisplay" class="pill" aria-live="polite">Kippa : 0</div>
        <div id="cpsDisplay" class="pill">CPS : 0</div>
        <div id="cpcDisplay" class="pill">Par clic : 1</div>
      </div>
    </header>

    <div class="layout">
      <section class="clickZone" aria-label="Zone de clic">
        <div id="cookieWrap">
          <div id="cookieSpinner" class="spin">
            <img id="cookieImage" src="https://i.postimg.cc/dVRtQ1xP/kippa.png" alt="Grosse Kippa cliquable">
          </div>
          <div class="clickHint">Tapez sur la Kippa — ou <kbd>Espace</kbd> au clavier</div>
          <div id="orbitLayer" aria-hidden="true"></div>
        </div>

        <div class="controls">
          <button id="resetBtn" class="btn" title="Réinitialiser la progression">Réinitialiser</button>
          <label class="switch"><input type="checkbox" id="muteToggle"> Muet</label>
          <span class="badge" id="saveBadge" title="Sauvegarde automatique">Sauvegarde auto</span>
        </div>

        <div id="floatLayer" aria-hidden="true"></div>
        <div id="burstLayer" aria-hidden="true"></div>
        <audio id="clickSound" src="https://han-han-boop.github.io/Mushlam/Kes.mp3" preload="auto"></audio>
      </section>

      <aside class="shop" id="shop" aria-label="Boutique">
        <h2>Boutique</h2>
      </aside>
    </div>

    <footer><span class="badge">Astuce : Maj-clic = ×10 | Ctrl-clic = “max”</span></footer>
  </div>

  <script>
    // ====== CONFIG ======
    const COST_FACTOR_DEFAULT = 1.25;
    const TICK_MS = 250;

    // ====== ÉTAT ======
    let cookies = 0, muted = false, lastOrbitLevel = -1, lastBgCount = -1;
    const upgrades = {
      upgrade1:{ id:'upgrade1', name:'Synagogue', desc:'Augmente les Kippa gagnés par clic.', icon:'https://i.postimg.cc/gJxx0phV/synagogue.png', sound:'https://han-han-boop.github.io/Mushlam/Mushlam.mp3', level:0, baseCost:2, cost:2, costFactor:COST_FACTOR_DEFAULT, multiplier:1 },
      upgrade2:{ id:'upgrade2', name:'Rabbin', desc:'Produit des Kippa automatiquement (KpS).', icon:'https://i.postimg.cc/C5Ddj4md/Rabbi.png', sound:'https://han-han-boop.github.io/Mushlam/ashk.mp3', level:0, baseCost:25, cost:25, costFactor:COST_FACTOR_DEFAULT, production:5 },
      upgrade3:{ id:'upgrade3', name:'Le Peuple Élu', desc:'Augmente toutes les productions de 25% par niveau.', icon:'https://i.postimg.cc/k5c4s4QF/elu.png', sound:'https://han-han-boop.github.io/Mushlam/Ye.mp3', level:0, baseCost:50, cost:50, costFactor:1.3, multiplier:25 }
    };

    // ====== OUTILS ======
    const nf = new Intl.NumberFormat('fr-FR');
    const shopEl = document.getElementById('shop');
    const cookieImg = document.getElementById('cookieImage');
    const currencyDisplay = document.getElementById('currencyDisplay');
    const cpsDisplay = document.getElementById('cpsDisplay');
    const cpcDisplay = document.getElementById('cpcDisplay');
    const clickSound = document.getElementById('clickSound');
    const floatLayer = document.getElementById('floatLayer');
    const burstLayer = document.getElementById('burstLayer');
    const megaFlash = document.getElementById('megaFlash');
    const orbitLayer = document.getElementById('orbitLayer');
    const muteToggle = document.getElementById('muteToggle');
    const resetBtn = document.getElementById('resetBtn');
    const bgIconLayer = document.getElementById('bgIconLayer');

    const isTouch = matchMedia('(pointer: coarse)').matches;

    function save(){
      const data = { cookies, muted, upgrades:Object.fromEntries(Object.entries(upgrades).map(([k,u])=>[k,{level:u.level,cost:u.cost}])) };
      localStorage.setItem('cookie-clicker-save', JSON.stringify(data));
    }
    function load(){
      const raw = localStorage.getItem('cookie-clicker-save'); if(!raw) return;
      try{
        const data = JSON.parse(raw);
        if(typeof data.cookies === 'number') cookies = data.cookies;
        if(typeof data.muted === 'boolean') muted = data.muted;
        for(const k of Object.keys(upgrades)){
          if(data.upgrades?.[k]){ upgrades[k].level = data.upgrades[k].level|0; upgrades[k].cost = Math.max(1, data.upgrades[k].cost|0); }
        }
      }catch{ localStorage.removeItem('cookie-clicker-save'); }
    }
    function formatCookies(x){
      if(x<10000) return nf.format(Math.floor(x));
      const u=["","K","M","Md","Bn","Bd"]; let i=0,n=x; while(n>=1000 && i<u.length-1){n/=1000;i++}
      return `${n.toFixed(n<10?2:1)}${u[i]}`.replace('.', ',');
    }
    const globalMultiplier = ()=> 1 + upgrades.upgrade3.level*(upgrades.upgrade3.multiplier/100);
    const cookiesPerClick = ()=> (1 + upgrades.upgrade1.level*upgrades.upgrade1.multiplier) * globalMultiplier();
    const cookiesPerSecond = ()=> (upgrades.upgrade2.level*upgrades.upgrade2.production) * globalMultiplier();

    // ====== UI ======
    function updateHUD(){
      currencyDisplay.textContent = `Kippa : ${formatCookies(cookies)}`;
      cpsDisplay.textContent = `Kippa par seconde : ${formatCookies(cookiesPerSecond())}`;
      cpcDisplay.textContent = `Kippa par clic : ${formatCookies(cookiesPerClick())}`;
    }
    function createUpgradeCard(u){
      const card = document.createElement('div');
      card.className='upgrade'; card.id=u.id;
      card.innerHTML = `
        <img src="${u.icon}" alt="${u.name}">
        <div>
          <div class="u-title">${u.name}</div>
          <div class="u-desc">${u.desc}</div>
          <div class="u-meta">
            <span class="badge">Niv. <span class="lv">${u.level}</span></span>
            <span class="badge">Effet : ${u.id==='upgrade1'?`+${u.multiplier}/clic`:(u.id==='upgrade2'?`+${u.production} KpS`:`+${u.multiplier}% global`)}</span>
          </div>
        </div>
        <div class="u-actions">
          <div class="price">Coût : <span class="cost">${nf.format(u.cost)}</span></div>
          <button class="buy" aria-label="Acheter ${u.name}">Acheter</button>
        </div>`;
      card.querySelector('.buy').addEventListener('click',ev=>{
        const bulk = ev.shiftKey?10:(ev.ctrlKey?'max':1); buyUpgrade(u.id, bulk);
      });
      return card;
    }
    function renderShop(){
      shopEl.querySelectorAll('.upgrade').forEach(n=>n.remove());
      for(const u of Object.values(upgrades)) shopEl.appendChild(createUpgradeCard(u));
      updateShopState();
    }
    function updateShopState(){
      for(const [id,u] of Object.entries(upgrades)){
        const card=document.getElementById(id); if(!card) continue;
        card.querySelector('.lv').textContent=u.level;
        card.querySelector('.cost').textContent=nf.format(u.cost);
        card.querySelector('.buy').disabled = cookies < u.cost;
      }
    }

    // ====== ACHATS ======
    function buyUpgrade(id, bulk=1){
      const u = upgrades[id]; if(!u) return;
      if(bulk==='max'){
        let bought=0, cost=u.cost, factor=u.costFactor;
        while(cookies>=cost){
          cookies-=cost; u.level++; if(id==='upgrade1') addBackgroundIconUpgrade1();
          bought++; if(u.sound) new Audio(u.sound).play();
          cost=Math.max(1,Math.round(cost*factor));
        }
        if(bought>0){ u.cost=cost; if(id==='upgrade3') showMegaFlash(); onStateChange(); }
        return;
      }
      let boughtCount=0;
      for(let i=0;i<bulk;i++){
        if(cookies<u.cost) break;
        cookies-=u.cost; u.level++; if(id==='upgrade1') addBackgroundIconUpgrade1();
        boughtCount++; if(u.sound) new Audio(u.sound).play();
        u.cost=Math.max(1,Math.round(u.cost*u.costFactor));
      }
      if(id==='upgrade3' && boughtCount>0) showMegaFlash();
      onStateChange();
    }

    // ====== INTERACTIONS ======
    function spawnFloat(x,y,txt){
      const el=document.createElement('div'); el.className='float go'; el.textContent=`+${formatCookies(txt)}`;
      el.style.left=x+'px'; el.style.top=y+'px'; el.style.color=Math.random()>.5?'var(--accent)':'var(--accent-2)';
      floatLayer.appendChild(el); setTimeout(()=>el.remove(),900);
    }
    function clickCookie(evt){
      const add=cookiesPerClick(); cookies+=add;
      const rect=cookieImg.getBoundingClientRect();
      const x=(evt?.clientX ?? (rect.left+rect.width/2));
      const y=(evt?.clientY ?? (rect.top+rect.height/2));
      spawnFloat(x,y,add);
      burstCookies(isTouch?6:10, 2400);
      pulseCookie(); playClick(); onStateChange();
    }
    function pulseCookie(){
      cookieImg.style.transform='scale(0.96)';
      requestAnimationFrame(()=>{ setTimeout(()=>{cookieImg.style.transform='';},80); });
    }
    function playClick(){ if(muted) return; try{ clickSound.currentTime=0; clickSound.play(); }catch{} }

    cookieImg.addEventListener('click', clickCookie, {passive:true});
    window.addEventListener('keydown', e=>{ if(e.code==='Space'||e.key===' '){ e.preventDefault(); clickCookie(); }});
    muteToggle.addEventListener('change', ()=>{ muted = muteToggle.checked; onStateChange(false) });
    resetBtn.addEventListener('click', ()=>{
      if(confirm('Réinitialiser la progression ?')){
        cookies=0; muted=false;
        for(const u of Object.values(upgrades)){ u.level=0; u.cost=u.baseCost; }
        muteToggle.checked=false; onStateChange();
      }
    });

    let saveTimer=0;
    function onStateChange(saveNow=true){
      updateHUD(); updateShopState();
      if(upgrades.upgrade2.level!==lastOrbitLevel){ syncOrbitIcons(); lastOrbitLevel=upgrades.upgrade2.level; }
      if(upgrades.upgrade1.level!==lastBgCount){ syncBgIcons(); lastBgCount=upgrades.upgrade1.level; }
      if(saveNow){ save(); }
    }

    // ====== CPS LOOP ======
    setInterval(()=>{
      cookies += cookiesPerSecond() * (TICK_MS/1000);
      saveTimer += TICK_MS; if(saveTimer>=3000){ save(); saveTimer=0; }
      updateHUD(); updateShopState();
    }, TICK_MS);

    // ====== INIT ======
    function init(){ load(); muteToggle.checked=muted; renderShop(); onStateChange(false); syncBgIcons(); syncOrbitIcons(); }
    init();

    // ====== EFFETS ======
    function burstCookies(count=10, duration=3000){
      const layer=burstLayer; if(!layer) return;
      for(let i=0;i<count;i++){
        const img=document.createElement('img'); const size=Math.floor(20+Math.random()*40);
        img.src=cookieImg.src; img.alt='mini cookie'; img.className='miniCookie';
        img.style.width=size+'px'; img.style.height=size+'px';
        img.style.left=Math.floor(Math.random()*100)+'%'; img.style.top=Math.floor(Math.random()*100)+'%';
        img.style.setProperty('--burst-duration', duration+'ms');
        layer.appendChild(img); img.addEventListener('animationend',()=>img.remove());
      }
    }

    // ====== ORBITES ======
    function getOrbitRadius(){
      const rect=cookieImg.getBoundingClientRect();
      const extra = (matchMedia('(pointer: coarse)').matches ? 26 : 50);
      return Math.round(rect.width/2) + extra;
    }

    // Mobile : angles aléatoires mais espacés. Desktop : aléatoire pur (inchangé).
    function useSpacedAngles(){
      return window.matchMedia('(max-width: 800px)').matches || window.matchMedia('(pointer: coarse)').matches;
    }
    let orbitAngles = [];                // angles utilisés (mobile)
    const ORBIT_MIN_GAP = 22;            // écart mini en degrés

    function pickAngle(){
      for(let t=0;t<120;t++){
        const a = Math.floor(Math.random()*360);
        const ok = orbitAngles.every(prev=>{
          const diff = Math.abs(((a - prev + 540) % 360) - 180);
          return diff >= ORBIT_MIN_GAP;
        });
        if(ok) return a;
      }
      // fallback : angle le plus éloigné (pas de cluster)
      let bestA=0, bestD=-1;
      for(let a=0;a<360;a+=5){
        const d = orbitAngles.length ? Math.min(...orbitAngles.map(prev => Math.abs(((a - prev + 540)%360) - 180))) : 360;
        if(d>bestD){ bestD=d; bestA=a; }
      }
      return bestA;
    }

    function addOrbitIcon(){
      if(!orbitLayer) return;
      const orb=document.createElement('div'); orb.className='orb';
      const img=document.createElement('img'); img.className='orbitIcon'; img.src=upgrades.upgrade2.icon; img.alt='Icône production auto';

      let angle;
      if(useSpacedAngles()){ angle = pickAngle(); orbitAngles.push(angle); }
      else{ angle = Math.floor(Math.random()*360); }

      const speed=(14+Math.random()*12).toFixed(1);
      const wobble=(1.8+Math.random()*1.6).toFixed(1);
      const size=Math.floor(45+Math.random()*25);
      const radius=getOrbitRadius()+Math.floor(-70+Math.random()*60);

      orb.style.setProperty('--a0', angle+'deg');
      orb.style.setProperty('--speed', speed+'s');
      img.style.setProperty('--size', size+'px');
      img.style.setProperty('--r', radius+'px');
      img.style.setProperty('--wobble', wobble+'s');

      orbitLayer.appendChild(orb); orb.appendChild(img);
    }

    function syncOrbitIcons(){
      const needed=(upgrades.upgrade2.level|0), current=orbitLayer.children.length;
      if(current<needed){
        for(let i=0;i<needed-current;i++) addOrbitIcon();
      }else if(current>needed){
        for(let i=current-1;i>=needed;i--){
          orbitLayer.children[i].remove();
          if(useSpacedAngles() && orbitAngles.length) orbitAngles.pop();
        }
      }
    }

    function recalibrateOrbitRadii(){
      const base=getOrbitRadius();
      Array.from(orbitLayer.children).forEach(orb=>{
        const img=orb.firstElementChild; if(!img) return;
        const cur=parseInt((img.style.getPropertyValue('--r')||'0').replace('px',''))||base;
        const delta=Math.max(-40, Math.min(40, cur-base));
        img.style.setProperty('--r', (base+delta)+'px');
      });
    }

    let lastAngleMode = useSpacedAngles();
    window.addEventListener('resize', ()=>{
      const mode = useSpacedAngles();
      if(mode !== lastAngleMode){
        // reconstruit l’anneau selon le nouveau mode
        const n = orbitLayer.children.length;
        orbitAngles = [];
        Array.from(orbitLayer.children).forEach(el=>el.remove());
        for(let i=0;i<n;i++) addOrbitIcon();
        lastAngleMode = mode;
      }else{
        recalibrateOrbitRadii();
      }
    });

    // ====== FLASH ======
    function showMegaFlash(){
      if(!megaFlash) return;
      megaFlash.innerHTML='';
      const img=document.createElement('img');
      img.src=upgrades.upgrade3.icon; img.alt='Super Boost';
      megaFlash.appendChild(img);
      megaFlash.classList.remove('show'); void megaFlash.offsetWidth;
      megaFlash.classList.add('show');
      setTimeout(()=>{ megaFlash.classList.remove('show'); megaFlash.innerHTML=''; }, 2100);
    }

    // ====== BG ICONS (upgrade1) ======
    function addBackgroundIconUpgrade1(){
      const img=document.createElement('img'); img.className='bgIcon'; img.src=upgrades.upgrade1.icon; img.alt='Multiplicateur';
      img.style.left=Math.floor(Math.random()*100)+'%'; img.style.top=Math.floor(Math.random()*100)+'%';
      img.style.setProperty('--rot', (Math.floor(-20+Math.random()*40))+'deg');
      img.style.setProperty('--scale', (0.5+Math.random()*1.1).toFixed(2));
      img.style.opacity=(0.18+Math.random()*0.6).toFixed(2);
      bgIconLayer.appendChild(img);
    }
    function syncBgIcons(){
      const needed=upgrades.upgrade1.level|0, current=bgIconLayer.children.length;
      if(current<needed){ for(let i=0;i<needed-current;i++) addBackgroundIconUpgrade1(); }
      else if(current>needed){ for(let i=current-1;i>=needed;i--) bgIconLayer.children[i].remove(); }
    }
  </script>
</body>
</html>
